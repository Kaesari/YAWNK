{% extends 'shared/base.html' %}

{% load static %}

{% block title %}Product Details{% endblock %}

{% block content %}
<main>
    <div class="mt-4">
       <div class="container">
          <!-- row -->
          <div class="row">
             <!-- col -->
             <div class="col-12">
                <!-- breadcrumb -->
                <nav aria-label="breadcrumb">
                   <ol class="breadcrumb mb-0">
                      <li class="breadcrsumb-item"><a href="/" class="text-info">Home</a></li> /
                      <li class="breadcrumb-item"><a href="{% url 'product_detail' product.id %}" class="text-info">{{ product.name }}</a></li>

                      <!-- <li class="breadcrumb-item active" aria-current="page">Napolitanke Ljesnjak</li> -->
                   </ol>
                </nav>
             </div>
          </div>
       </div>
    </div>
    <section class="mt-8">
       <div class="container">
          <div class="row">
             <div class="col-lg-6">
               <!-- img slide -->
               <div class="product productModal" id="productModal">
                  {% for image in product.images.all %}
                   <div class="zoom" onmousemove="zoom(event)" style="background-image: url('{{ image.image.url }}')">
                      <!-- img -->
                      <!-- img -->
                      <img src="{{ image.image.url }}" alt="" />
                   </div>
                  {% empty %}
                     <p>No extra images</p>
                  {% endfor %}
               </div>
               <!-- product tools -->
               <div class="product-tools">
                  <div class="thumbnails row g-3" id="productModalThumbnails">
                     {% for image in product.images.all %}
                      <div class="col-3">
                         <div class="thumbnails-img">
                            <!-- img -->
                            <img src="{{ image.image.url }}" alt="" />
                         </div>
                      </div>
                     {% endfor %}
                  </div>
               </div>
            </div>
             <div class="col-md-7 col-xl-6">
                <div class="ps-lg-10 mt-6 mt-md-0">
                   <!-- content -->
                   <a href="#!" class="mb-4 d-block text-info">{{ product.category }}</a>
                   <!-- heading -->
                   <h1 class="mb-1">{{ product.name }}</h1>
                   <div class="mb-4">
                      <!-- rating -->
                      <!-- rating -->
                      <small class="text-warning">
                        {% for i in "12345" %}
                            {% if forloop.counter <= product.average_rating %}
                            <i class="bi bi-star-fill"></i>
                            {% else %}
                            <i class="bi bi-star"></i>
                            {% endif %}
                        {% endfor %}
                      </small>
                      <a href="#" class="ms-2 text-info">({{ reviews.count }} reviews)</a>
                   </div>
                   <div class="fs-4">
                      <!-- price -->
                      <span class="fw-bold text-dark">Ksh {{ product.price }}</span>
                      <!-- <span class="text-decoration-line-through text-muted">$35</span>
                      <span><small class="fs-6 ms-2 text-danger">26% Off</small></span> -->
                   </div>
                   <!-- hr -->
                   <hr class="my-6" />
                   <!-- <div class="mb-5">
                      <button type="button" class="btn btn-outline-secondary">250g</button>
                      <button type="button" class="btn btn-outline-secondary">500g</button>
                      <button type="button" class="btn btn-outline-secondary">1kg</button>
                   </div>
                   <div>
                      <div class="input-group input-spinner">
                         <input type="button" value="-" class="button-minus btn btn-sm" data-field="quantity" />
                         <input type="number" step="1" max="10" value="1" name="quantity" class="quantity-field form-control-sm form-input" />
                         <input type="button" value="+" class="button-plus btn btn-sm" data-field="quantity" />
                      </div>
                   </div> -->
                   <div class="mt-3 row justify-content-start g-2 align-items-center">
                      <div class="col-xxl-4 col-lg-4 col-md-5 col-5 d-grid">
                         <!-- button -->
                         <!-- btn -->
                         
                         <!-- <a href="{% url 'my_chats' %}" 
                           class="btn btn-primary"
                           role="button"
                           aria-label="Message seller about this product">
                           <i class="feather-icon icon-shopping-bag me-2"></i>
                           Message Seller
                        </a> -->
                        
                        {% if user.is_authenticated and user != product.seller %}
                           <form method="GET" action="{% url 'start_chat' product.id %}" class="d-inline">
                           <button type="submit" class="btn btn-primary">
                              <i class="feather-icon icon-message-circle me-2"></i>
                              Message Seller
                           </button>
                           </form>
                           {% else %}
                           <form method="GET" action="{% url 'login' %}?next={% url 'start_chat' product.id %}" class="d-inline">
                              <button type="submit" class="btn btn-primary">
                                  <i class="feather-icon icon-message-circle me-2"></i>
                                  Message Seller
                              </button>
                          </form>
                          
                        {% endif %}

                        {% if user.is_authenticated and user == product.seller %}
                           <!-- <button class="btn btn-primary" 
                                 data-bs-toggle="tooltip" 
                                 title="{% if not user.is_authenticated %}Please login to message seller{% else %}You cannot message yourself{% endif %}">
                                 <i class="feather-icon icon-edit me-2"></i>
                           Edit Product
                           </button> -->
                           <button class="btn btn-primary" 
                              data-bs-toggle="tooltip" 
                              title="{% if not user.is_authenticated %}Please login to message seller{% else %}You cannot message yourself{% endif %}">
                              <a href="{% url 'update_product' product.id %}" style="text-decoration: none; color: inherit;">
                                 <i class="feather-icon icon-edit me-2"></i>
                                 Edit Product
                              </a>
                           </button>

                        {% endif %}
                      </div>
                      <div class="col-md-4 col-4">
                         <!-- btn -->
                         <!-- <a class="btn btn-light" href="#" data-bs-toggle="tooltip" data-bs-html="true" aria-label="Compare"><i class="bi bi-arrow-left-right"></i></a> -->
                         <!--  -->
                         {% if user.is_authenticated and user != product.seller  %}
                         <form method="POST" action="{% url 'toggle_wishlist' product.id %}">
                             {% csrf_token %}
                             {% if product in user.wishlist.all %}
                                 <button type="submit" class="btn btn-light">‚ù§Ô∏è Added to Wishlist</button>
                             {% else %}
                                 <button type="submit" class="btn btn-light">ü§ç Add to Wishlist</button>
                             {% endif %}
                         </form>
                     {% endif %}

                         <!-- <a class="btn btn-light" href="" data-bs-toggle="tooltip" data-bs-html="true" aria-label="Wishlist"><i class="feather-icon icon-heart"></i></a> -->
                      </div>
                   </div>
                   <!-- hr -->
                   <hr class="my-6" />
                   <div>
                      <!-- table -->
                      <table class="table table-borderless mb-0">
                         <tbody>
                            <tr>
                               <td>Product Size:</td>
                               <td>{{ product.size }}</td>
                            </tr>
                            <tr>
                               <td>Availability:</td>
                               <td>In Stock</td>
                            </tr>
                            <tr>
                               <td>Category:</td>
                               <td>{{ product.category }}</td>
                            </tr>
                            <tr>
                              <td>Condition:</td>
                              <td>{{ product.condition }}</td>
                           </tr>
                           {% if user.is_authenticated and product.seller != user %}
                           
                           <td>
                              <!-- Form for following/unfollowing the seller -->
                              <!-- <form method="POST" action="{% url 'follow_toggle' product.seller.id product.id %}" style="display:inline;">
                                  {% csrf_token %}
                                  {% if is_following %}
                                      <button class="btn btn-primary" type="submit" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Unfollow Seller">Unfollow Seller</button>
                                  {% else %}
                                      <button class="btn btn-primary" type="submit" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Follow Seller for new posts">Follow Seller</button>
                                  {% endif %}
                              </form> -->

                              <button class="btn btn-primary" 
                                 data-bs-toggle="tooltip" 
                                 title="{% if not user.is_authenticated %}Please login to message seller{% else %}You cannot message yourself{% endif %}">
                                 <a href="{% url 'seller_feed' product.seller.id %}" style="text-decoration: none; color: inherit;">
                                    <!-- <i class="feather-icon icon-edit me-2"></i> -->
                                    <i class="bi bi-eye me-2"></i>
                                    Seller Profile
                                 </a>
                              </button>
                          </td>
                          
                          {% endif %}
                           
                         </tbody>
                      </table>
                   </div>
                   <!-- <div class="mt-8">
                      <div class="dropdown">
                         <a class="btn btn-outline-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Share</a>

                         <ul class="dropdown-menu">
                            <li>
                               <a class="dropdown-item" href="#">
                                  <i class="bi bi-facebook me-2"></i>
                                  Facebook
                               </a>
                            </li>
                            <li>
                               <a class="dropdown-item" href="#">
                                  <i class="bi bi-twitter me-2"></i>
                                  Twitter
                               </a>
                            </li>
                            <li>
                               <a class="dropdown-item" href="#">
                                  <i class="bi bi-instagram me-2"></i>
                                  Instagram
                               </a>
                            </li>
                         </ul>
                      </div>
                   </div> -->
                </div>
             </div>
          </div>
       </div>
    </section>
    <section class="mt-lg-14 mt-8">
       <div class="container">
          <div class="row">
             <div class="col-md-12">
                <ul class="nav nav-pills nav-lb-tab" id="myTab" role="tablist">
                   <!-- nav item -->
                   <li class="nav-item" role="presentation">
                      <!-- btn -->
                      <button
                         class="nav-link active"
                         id="product-tab"
                         data-bs-toggle="tab"
                         data-bs-target="#product-tab-pane"
                         type="button"
                         role="tab"
                         aria-controls="product-tab-pane"
                         aria-selected="true">
                         Product Description
                      </button>
                   </li>
                   <!-- nav item -->
                   <!-- <li class="nav-item" role="presentation">
                      <button
                         class="nav-link"
                         id="details-tab"
                         data-bs-toggle="tab"
                         data-bs-target="#details-tab-pane"
                         type="button"
                         role="tab"
                         aria-controls="details-tab-pane"
                         aria-selected="false">
                         Information
                      </button>
                   </li> -->
                   <!-- nav item -->
                   <li class="nav-item" role="presentation">
                      <!-- btn -->
                      <button
                         class="nav-link"
                         id="reviews-tab"
                         data-bs-toggle="tab"
                         data-bs-target="#reviews-tab-pane"
                         type="button"
                         role="tab"
                         aria-controls="reviews-tab-pane"
                         aria-selected="false">
                         Reviews
                      </button>
                   </li>
                   <!-- nav item -->
                   <!-- <li class="nav-item" role="presentation">
                      <button
                         class="nav-link"
                         id="sellerInfo-tab"
                         data-bs-toggle="tab"
                         data-bs-target="#sellerInfo-tab-pane"
                         type="button"
                         role="tab"
                         aria-controls="sellerInfo-tab-pane"
                         aria-selected="false"
                         disabled>
                         Seller Info
                      </button>
                   </li> -->
                </ul>
                <!-- tab content -->
                <div class="tab-content" id="myTabContent">
                   <!-- tab pane -->
                   <div class="tab-pane fade show active" id="product-tab-pane" role="tabpanel" aria-labelledby="product-tab" tabindex="0">
                      <div class="my-8">
                         <div class="mb-5">
                            <!-- text -->
                            <h4 class="mb-1">Description</h4>
                            <p class="mb-0">
                              {{ product.description }}
                            </p>
                         </div>
                         <!-- <div class="mb-5">
                            <h5 class="mb-1">Storage Tips</h5>
                            <p class="mb-0">
                               Nisi, tellus iaculis urna bibendum in lacus, integer. Id imperdiet vitae varius sed magnis eu nisi nunc sit. Vel, varius habitant ornare ac rhoncus. Consequat risus
                               facilisis ante ipsum netus risus adipiscing sagittis sed.Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                            </p>
                         </div> -->
                         <!-- content -->
                         <!-- <div class="mb-5">
                            <h5 class="mb-1">Unit</h5>
                            <p class="mb-0">3 units</p>
                         </div> -->
                         <!-- <div class="mb-5">
                            <h5 class="mb-1">Seller</h5>
                            <p class="mb-0">DMart Pvt. LTD</p>
                         </div> -->
                         <div>
                            <h5 class="mb-1">Disclaimer</h5>
                            <p class="mb-0">
                               Image shown is a representation and may slightly vary from the actual product. Every effort is made to maintain accuracy of all information displayed.
                            </p>
                         </div>
                      </div>
                   </div>
                   <!-- tab pane -->
                   <div class="tab-pane fade" id="details-tab-pane" role="tabpanel" aria-labelledby="details-tab" tabindex="0">
                      <div class="my-8">
                         <div class="row">
                            <div class="col-12">
                               <h4 class="mb-4">Details</h4>
                            </div>
                            <div class="col-12 col-lg-6">
                               <table class="table table-striped">
                                  <!-- table -->
                                  <tbody>
                                     <tr>
                                        <th>Weight</th>
                                        <td>1000 Grams</td>
                                     </tr>
                                     <tr>
                                        <th>Ingredient Type</th>
                                        <td>Vegetarian</td>
                                     </tr>
                                     <tr>
                                        <th>Brand</th>
                                        <td>Dmart</td>
                                     </tr>
                                     <tr>
                                        <th>Item Package Quantity</th>
                                        <td>1</td>
                                     </tr>
                                     <tr>
                                        <th>Form</th>
                                        <td>Larry the Bird</td>
                                     </tr>
                                     <tr>
                                        <th>Manufacturer</th>
                                        <td>Dmart</td>
                                     </tr>
                                     <tr>
                                        <th>Net Quantity</th>
                                        <td>340.0 Gram</td>
                                     </tr>
                                     <tr>
                                        <th>Product Dimensions</th>
                                        <td>9.6 x 7.49 x 18.49 cm</td>
                                     </tr>
                                  </tbody>
                               </table>
                            </div>
                            <div class="col-12 col-lg-6">
                               <table class="table table-striped">
                                  <!-- table -->
                                  <tbody>
                                     <tr>
                                        <th>ASIN</th>
                                        <td>SB0025UJ75W</td>
                                     </tr>
                                     <tr>
                                        <th>Best Sellers Rank</th>
                                        <td>#2 in Fruits</td>
                                     </tr>
                                     <tr>
                                        <th>Date First Available</th>
                                        <td>30 April 2022</td>
                                     </tr>
                                     <tr>
                                        <th>Item Weight</th>
                                        <td>500g</td>
                                     </tr>
                                     <tr>
                                        <th>Generic Name</th>
                                        <td>Banana Robusta</td>
                                     </tr>
                                  </tbody>
                               </table>
                            </div>
                         </div>
                      </div>
                   </div>
                   <!-- tab pane -->
                   <div class="tab-pane fade" id="reviews-tab-pane" role="tabpanel" aria-labelledby="reviews-tab" tabindex="0">
                      <div class="my-8">
                         <!-- row -->
                         <div class="row">
                            
                            <!-- col -->
                            <div class="col-md-12">
                               <div class="mb-10">
                                  <div class="d-flex justify-content-between align-items-center mb-8">
                                     <div>
                                        <!-- heading -->
                                        <h4>Reviews</h4>
                                     </div>
                                     <div>
                                        <select class="form-select">
                                           <option selected>Top Reviews</option>
                                           <!-- <option value="Most Recent">Most Recent</option> -->
                                        </select>
                                     </div>
                                  </div>
                                  {% for review in reviews %}
                                  <div class="d-flex border-bottom pb-6 mb-6">
                                     <!-- img -->
                                     <!-- img -->
                                          <!-- Reviewer's Avatar -->
                                       {% if review.reviewer.profile_picture %}
                                          <img src="{{ review.reviewer.profile_picture.url }}" 
                                                alt="{{ review.reviewer.username }}" 
                                                class="rounded-circle avatar-lg"
                                                style="width: 60px; height: 60px; object-fit: cover;">
                                       {% else %}
                                          <img src="{% static 'assets/images/added/user-profile.png' %}" 
                                                alt="Default avatar" 
                                                class="rounded-circle avatar-lg"
                                                style="width: 60px; height: 60px; object-fit: cover;">
                                       {% endif %}
                                     <!-- <img src="{% static 'assets/images/avatar/avatar-10.jpg' %}" alt="" class="rounded-circle avatar-lg" /> -->
                                     
                                     <div class="ms-5">
                                        <h6 class="mb-1">{{ review.reviewer }}</h6>
                                        <!-- select option -->
                                        <!-- content -->
                                        <p class="small">
                                           <span class="text-muted">{{ review.timestamp }}</span>
                                           <span class="text-primary ms-3 fw-bold">Verified Review</span>
                                        </p>
                                        <div class="mb-2">
                                             <!-- rating -->
                                             <!-- rating -->
                                             <small class="text-warning">
                                             {% for i in "12345" %}
                                                   {% if forloop.counter <= review.rating %}
                                                   <i class="bi bi-star-fill"></i>
                                                   {% else %}
                                                   <i class="bi bi-star"></i>
                                                   {% endif %}
                                             {% endfor %}
                                             </small>
                                             <!-- <a href="#" class="ms-2">({{ reviews.count }} reviews)</a> -->
                                          </div>
                                          <!-- text-->
                                          <p>
                                             {{ review.comment }}
                                          </p>
                                          <!-- icon -->
                                     </div>
                                  
                                    </div>
                                   {%empty%} 
                                   <p><em>This product is not yet reviewed.</em></p>
                                  {% endfor %}
                                  <!-- <div>
                                     <a href="#" class="btn btn-outline-gray-400 text-muted">Read More Reviews</a>
                                  </div> -->
                               </div>
                               {% if user.is_authenticated and user != product.seller %}
                                 {% if review_form %}
                                    <h4>{% if review_form.instance.pk %}Edit{% else %}Leave{% endif %} a Review</h4>
                                    <form method="POST">
                                       {% csrf_token %}
                                       {{ review_form.as_p }}
                                       
                                       <div class="d-flex justify-content-start gap-2">
                                             <!-- Submit/Update Button -->
                                             <button type="submit" class="btn btn-primary">
                                                {% if review_form.instance.pk %}Update{% else %}Submit{% endif %}
                                             </button>
                                             
                                             <!-- Delete Button (conditionally shown) -->
                                             <!-- {% if review_form.instance.pk %}
                                                <form method="POST" action="{% url 'delete_review' product.id %}" class="d-inline">
                                                   {% csrf_token %}
                                                   <button type="submit" class="btn btn-danger" 
                                                            onclick="return confirm('Delete your review?');">
                                                         üóëÔ∏è Delete Review
                                                   </button>
                                                </form>
                                             {% endif %} -->
                                       </div>
                                    </form>
                                 {% else %}
                                    <p><em>Only verified buyers who've chatted with the seller can leave a review.</em></p>
                                 {% endif %}
                              {% endif %}
                               
                            </div>
                         </div>
                      </div>
                   </div>
                   <!-- tab pane -->
                   <div class="tab-pane fade" id="sellerInfo-tab-pane" role="tabpanel" aria-labelledby="sellerInfo-tab" tabindex="0">...</div>
                </div>
             </div>
          </div>
       </div>
    </section>

    <!-- section -->
    <section class="my-lg-14 my-14">
       <div class="container">
          <!-- row -->
          <div class="row">
             <div class="col-12">
                <!-- heading -->
                <h3>Related Items</h3>
             </div>
          </div>
          <!-- slider -->
          <div class="product-slider">
             {% for product in RelatedProducts %}
             <div class="item">
               <!-- Wrap the entire card in an anchor tag to navigate to the product detail page -->
               <a href="{% url 'product_detail' product.id %}" class="text-decoration-none">
                  <div class="card card-product">
                     <div class="card-body">
                           <!-- badge -->
                           <div class="text-center position-relative">
                              <div class="position-absolute top-0 start-0">
                                 <span class="badge bg-info">Sale</span>
                              </div>
                              <!-- img -->
                              <img src="{{ product.image.url }}" alt="Grocery Ecommerce Template" class="mb-3 img-fluid" />
                           </div>
                           <!-- title -->
                           <div class="text-small mb-1">
                              <a href="#!" class="text-decoration-none text-muted"><small>{{ product.category }}</small></a>
                           </div>
                           <h2 class="fs-6"><a href="#!" class="text-inherit text-decoration-none">{{ product.name }}</a></h2>
                           <div>
                              <!-- rating -->
                              {% if product.reviews.exists %}
                              {% for i in "12345" %}
                                 {% if forloop.counter <= product.average_rating %}
                                 <small class="text-warning">
                                       <i class="bi bi-star-fill"></i>
                                 </small>
                                 {% else %}
                                 <small class="text-warning">
                                       <i class="bi bi-star"></i>
                                 </small>
                                 {% endif %}
                              {% endfor %}
                              {% else %}
                              {% for i in "12345" %}
                              {% if forloop.counter <= product.average_rating %}
                                 <small class="text-warning">
                                       <i class="bi bi-star-fill"></i>
                                 </small>
                              {% else %}
                                 <small class="text-warning">
                                       <i class="bi bi-star"></i>
                                 </small>
                              {% endif %}
                              {% endfor %}
                              {% endif %}
                              <span class="text-muted small">{{ product.average_rating }}({{ product.reviews.count }})</span>
                           </div>
                           <!-- price -->
                           <div class="d-flex justify-content-between align-items-center mt-3">
                              <div>
                                 <span class="text-dark">Ksh {{ product.price }}</span>
                              </div>
                              <!-- btn -->
                              <div>
                                 {% if user.is_authenticated and user != product.seller %}
                                 <a href="{% url 'start_chat' product.id %}" class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="tooltip" title="Message {{ product.seller }}">
                                       <i class="bi bi-chat-text-fill me-1"></i> DM
                                 </a>
                                 {% endif %}
         
                                 {% if not user.is_authenticated %}
                                 <a href="{% url 'login' %}?next={% url 'start_chat' product.id %}" class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="tooltip" title="Login to Message {{ product.seller }}">
                                       <i class="bi bi-chat-text-fill me-1"></i> DM
                                 </a>
                                 {% endif %}
                              </div>
                           </div>
                     </div>
                  </div>
               </a>
            </div>
             {% empty %}
                <p>No related products to show.</p>
             {% endfor %}
          </div>
       </div>
    </section>
 </main>
{% endblock %}