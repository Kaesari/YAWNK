{% extends 'contests/base.html' %}

{% load static %}

{% block title %}Team Selection{% endblock %}


{% load custom_filters %}

{% block content %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;" id="toastContainer">
</div>

<!-- Modal -->
<div id="leagueOptionsModal" class="modal fade" tabindex="-1" aria-labelledby="leagueOptionsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"> <!-- Centered modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leagueOptionsModalLabel">What would you like to do next?</h5>
                <button type="button" class="btn-close" id="dismissButton" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You can either create a new league and invite your friends or join an existing league to compete.</p>
            </div>
            <div class="modal-footer">
                <a href="/api/create-league/" class="btn btn-primary"
                    style="background: linear-gradient(to right, red, #007bff); color: white;">Create League</a>
                <a href="/api/league/" class="btn btn-secondary">Join League</a>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <!-- Navigation Buttons -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
            <a href="{% url 'manage_team_user_gameweek' current_game_week.id|add:"-1" %}" class="btn btn-outline-dark px-4 mb-2 mb-md-0" >Previous</a>
            
            {% if current_game_week %}
                <h3 class="fw-bold text-center mb-2 mb-md-0">Gameweek {{ current_game_week.id }}</h3>
                <h3 class="fw-bold text-center mb-2 mb-md-0"  id="current_gameweek" style="display: none;">{{ current_game_week.id }}</h3>
            {% else %}
                <h3 class="fw-bold text-center mb-2 mb-md-0">Gameweek not available</h3>
            {% endif %}
            
            <a href="{% url 'league' %}" class="btn btn-outline-dark px-4 mb-2 mb-md-0">Next</a>
        </div>


    <!-- Card Container (to right, red, #007bff)-->
    <div class="p-4 rounded shadow-sm" style="background: linear-gradient(to right, red, #007bff); color: white;">
        <!-- Card Content -->
        <div class="row row-cols-1 row-cols-md-2 g-4"> <!-- Bootstrap responsive classes for gaps -->
            <!-- Left Section -->
            <div class="col">
                <div class="rounded p-4 d-flex flex-column h-100"
                    style="background: linear-gradient(to left, red, #007bff); min-height: 200px;">

                    <!-- Image and Text -->
                    <div class="d-flex align-items-center flex-nowrap">
                        <img src="{% static 'images/gaolpost-1.png' %}" alt="Goal Post" class="me-3"
                            style="width: 60px; height: 60px; border-radius: 50%;">
                        <div>
                            <h3 class="fw-bold mb-1 text-dark">{{ user_team.name }}</h3>
                            <!-- <h3 class="fw-bold mb-1 text-dark" id="teamName" style="display: none;">{{ user_team.name }}#{{ user_team.id }}</h3> -->
                            <!-- <h3 class="fw-bold mb-1 text-dark" id="teamName" style="display: none;">{{ user_team.name }}</h3> -->
                            <h3 class="fw-bold mb-1 text-dark" id="teamName" style="display: none;">{{ user_team.name }}</h3>
                            <h3 class="fw-bold mb-1 text-dark" id="teamId" style="display: none;">{{ user_team.id }}</h3>
                            <p class="fw-bold mb-2 text-dark" style="font-size: 0.8rem;">{{ user_team.user.username }}
                            </p>
                        </div>
                    </div>

                    <!-- Points and Global Ranking -->
                    <div class="bg-dark text-white rounded p-3 mt-auto"> <!-- Added mt-auto to push content down -->
                        <div class="row d-flex align-items-center">
                            <!-- Points Section -->
                            <div class="col-4 text-center d-flex flex-column align-items-center justify-content-center">
                                <h1 class="fw-bold mb-0" style="color: white;">{{ team_score }}</h1>
                                <!-- Added mb-0 for tighter spacing -->
                                <p class="text-muted" style="color: white;">Points</p>
                            </div>
                            <!-- Global Rank and Highest Points Section -->
                            <div class="col-8">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span style="color: white;">Global rank</span>
                                    <span style="color: white;">{{user_position}}</span>
                                </div>
                                <hr class="fade-hr my-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span style="color: white;">Highest points</span>
                                    <span style="color: white;">{{leading_team_points}}</span>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Right Section -->
            <div class="col">
                <div class="rounded p-4 d-flex flex-column h-100"
                    style="background: linear-gradient(to left, red, #007bff); min-height: 200px;">
                    <h4 class="fw-bold  text-dark" style="font-size: 1.0rem;">Gameweek {{ current_game_week.id }} Challenge</h4>
                    <h5 class="fw-bold  text-dark">Legends</h5>
                    <p class="text-dark">⚡ Players who have been at their club for 5+ seasons earn double points</p>
                    <div class="d-flex justify-content-between mt-auto"> <!-- Added mt-auto to align inner boxes -->
                        <div class="p-3 rounded shadow-sm d-flex justify-content-between align-items-center"
                            style="background-color: #e8fff4; width: 100%; opacity: 0.8;">
                            <span class="text-dark" style="font-size: 0.8rem;">Players selected</span>
                            <div>
                                <span class="fw-bold text-dark">
                                    <span id="budgetDisplay">£100.0m</span>
                                    <span class="text-dark" style="font-size: 0.8rem;">Remaining budget</span>
                                </span>
                            </div>

                            <span class="fw-bold text-dark">Unlimited</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
<!-- Player Info Modal -->
<div id="playerModal" class="modal" 
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="modal-content"
        style="background: white; width: 95%; max-width: 600px; margin: 5% auto; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">

        <!-- Modal Header with Player Info -->
        <div style="background: linear-gradient(to right, #00A878, #0068B6); padding: 20px; color: white; text-align: left; position: relative; display: flex; justify-content: space-between; align-items: center;">
            <!-- Player Image (Moved to Right) -->
            <img src="{% static 'images/logoblack.png' %}" alt="Logo" style="position: absolute; top: 10px; left: 10px; height: 30px; width: auto;">

            <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 10px;">

                    <div id="captainBadge" style="display: none;">
                        <img src="{% static 'images/caption.png' %}" alt="Captain" style="height: 50px; width: auto; display: block;">
                    </div>

                    <div id="vicecaptainBadge" style="display: none;">
                        <img src="{% static 'images/vcaption.png' %}" alt="VCaptain" style="height: 50px; width: auto; display: block;">
                    </div>
                    
                    <!-- Corrected vertical alignment -->
                    <div style="display: flex; flex-direction: column; justify-content: center;">
                        <h3 id="modalPlayerName" 
                            style="margin: 0; font-size: 1.8rem; font-weight: bold; line-height: 1;">Player Name</h3>
                        <p id="modalPlayerPosition" 
                            style="margin: 0; font-size: 1.0rem; color: white;">Position</p>
                    </div>
                </div>                                               
            
                <div class="d-flex align-items-center" style="margin-top: 5px;">
                    <img id="modalTeamLogo" src="" width="24" height="24" alt="Team Logo"
                        style="margin-right: 5px;">
                    <span id="modalTeamName" class="text-white" style="font-size: 1.2rem;">Team Name</span>
                </div>
            </div>
              
            <!-- Player Image (Moved to Right) -->
            <img id="modalPlayerImage" src="{% static 'images/default3.png' %}" width="100" height="130" alt="Player"
                style="margin-right: 50px; margin-top: 50px; object-fit: cover;"> <!-- Removed border-radius -->

            <!-- Close Button -->
            <button id="closeModalButton"
                style="position: absolute; top: 10px; right: 10px; background: black; color: white; border: none; font-size: 0.8rem; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                ✖ Close
            </button>

        <!-- Floating Stats Section with Perfect Centering -->
        <div class="w-100" style="position: absolute; bottom: 10px; left: 0; right: 0; margin: 0 auto; max-width: 95%; background: #dfffd68e; padding: 5px; display: flex; justify-content: space-around; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.2);">
            <div style="text-align: center;">
                <p style="margin: 0; font-size: 0.5rem; font-weight: bold; color: #000;">Price</p>
                <h4 id="modalPlayerPrice" style="margin: 5px 0; font-size: 0.9rem; font-weight: bold;">£7.3m</h4>
            </div>
            <div style="text-align: center;">
                <p style="margin: 0; font-size: 0.5rem; font-weight: bold; color: #000;">Form</p>
                <h4 id="modalPlayerForm" style="margin: 5px 0; font-size: 0.9rem; font-weight: bold;">9.0</h4>
            </div>
            <div style="text-align: center;">
                <p style="margin: 0; font-size: 0.5rem; font-weight: bold; color: #000;">TSB%</p>
                <h4 id="modalPlayerTSB" style="margin: 5px 0; font-size: 0.9rem; font-weight: bold;">37.9%</h4>
            </div>
        </div>

        

        </div>

        <!-- Action Buttons -->
        <div style="display: flex; justify-content: center; gap: 10px; padding: 15px;">
            <button id="makeCaptainButton" class="btn"
                style="padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; background: white; border: 2px solid black; width: 48%;">
                Make Captain
            </button>
            <button id="makeViceCaptainButton" class="btn"
                style="padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; background: #7B3FA4; color: white; border: none; width: 48%;">
                Make Vice Captain
            </button>
            <button id="switchOutButton" class="btn"
                style="padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; background: linear-gradient(to right, #00A878, #0068B6); color: white; border: none; width: 48%;">
                Switch
            </button>
            <button id="transferOutButton" class="btn"
                style="padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; background: linear-gradient(to right, #00A878, #0068B6); color: white; border: none; width: 48%;">
                Replace
            </button>
        </div>

        <!-- Fixtures Section -->
        <div style="padding: 15px;">
            <h6 style="font-weight: bold; margin-bottom: 5px;text-align: center;">Gameweek {{ current_game_week.id }} Fixtures</h6>
            <p id="fixtureDate" style="color: #666; font-size: 0.9rem;">Saturday 15 February</p>
            <div style="padding: 15px; border-radius: 10px; background: #F9F9F9; display: flex; align-items: center; justify-content: space-between;">
                <div class="d-flex align-items-center">
                    <img id="fixtureTeam1Logo" src="{% static 'images/default3.png' %}" width="24" height="24" alt="Team 1">
                    <span id="fixtureTeam1Name" style="margin-left: 5px; font-weight: bold;">Crystal Palace</span>
                </div>
                <span id="fixtureTime" style="font-weight: bold;">20:30</span>
                <div class="d-flex align-items-center">
                    <span id="fixtureTeam2Name" style="margin-right: 5px; font-weight: bold;">Everton</span>
                    <img id="fixtureTeam2Logo" src="{% static 'images/default3.png' %}" width="24" height="24" alt="Team 2">
                </div>
            </div>
            <!-- <div style="text-align: center; margin-top: 10px;">
                <span class="badge" style="background: green; color: white; padding: 5px 10px; border-radius: 5px;">Easy</span>
            </div> -->
        </div>

    </div>
</div>




        <!-- Pitch Area -->
<div class="col-md-8 position-relative" id="targetDiv">
    <div style="text-align: center;">
        <a href="javascript:void(0);" id="hideDivLink" style="text-decoration: none; color: #5f3f85; font-size: 16px; font-weight: bold; border: 1px solid #5f3f85; padding: 5px 10px; border-radius: 5px;">
            Player List &rarr;
        </a>
    </div> 
    
      
    
            <div class="rounded position-relative">
                <img src="{% static 'images/pitch.png' %}" alt="Pitch" class="img-fluid w-100 rounded pitch-size">
                <div id="pitch-formation">
                <!-- Formation players will be dynamically injected here -->
                </div>
            
                <!-- Substitute Slots Section (Overlay at Bottom Center) -->
                <div id="subs-container" class="position-absolute" style="top: 90%; left: 50%; transform: translateX(-50%); width: 100%; display:none;">
                    <!-- This inner container will hold the clickable substitute slots -->
                    <div class="d-flex flex-nowrap justify-content-center gap-2 p-2 rounded overflow-x-auto">
                        <!-- The slots will be injected dynamically via JavaScript 
                        style="background: linear-gradient(to bottom, rgba(0,255,198,0.7), rgba(0,123,255,0.7));" -->
                    </div>
                </div>

                
            </div>
            <!-- Button Section -->
            <div class="container"  style="margin-top: 120px;">
                <div class="row g-3 justify-content-center align-items-center">
                    <!-- Formation Dropdown -->
                    <div class="col-12 col-md-auto d-flex align-items-center bg-light border rounded p-3">
                        <label for="formation-select" style="font-size: 16px; margin-right: 8px;">Choose
                            formation</label>
                        <select id="formation-select" class="form-select form-select-lg" style="width: 150px;">
                            <option value="4-4-2">4-4-2</option>
                            <option value="4-3-3">4-3-3</option>
                            <option value="4-5-1">4-5-1</option>
                            <option value="3-4-3">3-4-3</option>
                            <option value="3-5-2">3-5-2</option>
                            <option value="5-3-2">5-3-2</option>
                            <option value="5-4-1">5-4-1</option>
                        </select>
                    </div>

                    <!-- Buttons -->
                    <div class="col-12 col-md-auto">
                        <button id="resetButton" class="btn btn-outline-secondary btn-lg w-100 mb-2 mb-md-0"
                            style="padding: 5px 10px;">Reset</button>
                    </div>
                    <div class="col-12 col-md-auto">
                        <button class="btn btn-outline-secondary btn-lg w-100 mb-2 mb-md-0" id="autoPickButton"
                            style="padding: 5px 10px;">
                            Auto pick
                        </button>
                    </div>
                    <div class="col-12 col-md-auto">
                        <button id="saveTeamButton" class="btn btn-primary btn-lg w-100"
                            style="background: linear-gradient(to right, red, #007bff); color: rgb(255, 255, 255); padding: 10px 30px;">Save
                            team</button>
                    </div>

                </div>
            </div>

            <!-- Fixtures Section -->
            <div class="mt-4 bg-light rounded p-3">
                <h4 class="text-center fw-bold text-uppercase mb-3">Gameweek Fixtures</h4>
                <!-- <p class="text-center text-muted">Real-Time Matches </p> -->
                <div class="text-center mb-3">
                    <button class="btn btn-primary">Real-Time Matches</button>
                </div>

                <!-- Fixture List -->
                <div id="fixtureContainer">
                    {% for day in matches %}
                    <h5 class="fw-bold text-dark mt-4">{{ day.date }}</h5>
                    <div class="timeline mt-3">
                        {% for match in day.matches %}
                        <div class="d-flex align-items-center mb-3 bg-white rounded p-2 shadow-sm">
                            <!-- Match Time -->
                            <div class="me-2 text-center">
                                <span class="fw-bold">{{ match.formatted_time }}</span>
                                <p class="text-muted small">Next deadline</p>
                            </div>

                            <!-- Match Teams -->
                            <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                                <div class="d-flex align-items-centper me-2">
                                    <img src="{{ match.home_team.logo }}" alt="{{ match.home_team.name }}"
                                        class="img-fluid" style="height: 18px; width: 18px; margin-right: 6px;">
                                    <span style="font-size: 0.6rem !important;">{{ match.home_team.name }}</span>
                                </div>
                                <span class="fw-bold mx-2" style="font-size: 0.7rem;">vs</span>
                                <div class="d-flex align-items-center ms-2">
                                    <span style="font-size: 0.6rem !important;">{{ match.away_team.name }}</span>
                                    <img src="{{ match.away_team.logo }}" alt="{{ match.away_team.name }}"
                                        class="img-fluid" style="height: 18px; width: 18px; margin-left: 6px;">
                                </div>
                            </div>
                            

                            <!-- Sponsor Logo -->
                            <img src="{% static 'images/sponsor-logo.png' %}" alt="Sponsor" class="ms-3"
                                style="height: 24px;">
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination Controls -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button id="fixtures-prev-button" class="btn btn-light" disabled>&laquo; Previous</button>
                    <span>Page <span id="fixtures-current-page">1</span> of <span
                            id="fixtures-total-pages">1</span></span>
                    <button id="fixtures-next-button" class="btn btn-light">&raquo; Next</button>
                </div>
            </div>

            <!-- Team Selection -->
            <select class="form-select mb-3" id="teamSelect" style="display: none;">
                <option value="">Select a team...</option>
            </select>
</div>

        {% if user_id %}
        
        <!-- Player Selection -->
        <div class="col-md-4">
            <!-- <div class="bg-white p-4 rounded shadow-sm">
                <h5 class="fw-bold">Player Selection</h5>
                
            </div> -->
                <!-- Global Leagues Section -->
            <h4 class="fw-bold">Global Leagues</h4>
            <p class="text-muted">Join the Leagues to take on the best managers in the world.</p>

            {% if public_leagues %}
            {% for league in public_leagues %}
            <div class="p-3 bg-light rounded shadow-sm mb-3">
                <div class="col align-items-center">
                    <div class="col-12">
                        <p class="fw-bold mb-1"  style="font-size: 0.75rem;">{{ league.name }}</p>
                        <p class="text-muted mb-0">
                            <i class="fas fa-users me-2"  style="font-size: 0.75rem;"></i>{{ league.users.count }} players |
                            <span class="text-dark"  style="font-size: 0.75rem;">League Code: <span class="fw-bold">{{ league.league_code }}</span></span>
                        </p>
                    </div>
                    <div class="col-12 texgt-md-end">
                        <p class="fw-bold mb-1"  style="font-size: 0.75rem;">Prize Pool: Ksh {{ league.prize_pool }}</p>
                        <p class="text-muted mb-0"  style="font-size: 0.75rem;">Start Date: {{ league.start_date|date:"M d, Y" }} | Entry Fee: <span
                                class="fw-bold"  style="font-size: 0.75rem;">Ksh {{ league.entry_fee }}</span></p>
                        <!-- {% if user in league.users.all %}
                        <button class="btn btn-success px-4 mt-2" disabled>Joined</button>
                        {% else %}
                        <a href="{% url 'entry-payment' league.league_code %}" class="btn btn-primary px-4 mt-2"
                            style="background: linear-gradient(to right, red, #007bff); border: none;">Join</a>
                        {% endif %} -->
                    </div>
 
                    
                </div>

                <div class="col-12 d-flex justify-content-between align-items-center">
                    {% if user in league.users.all %}
                        <button class="btn btn-success px-4 mt-2" disabled>Joined</button>
                    {% else %}
                        <a href="{% url 'entry-payment' league.league_code %}" 
                           class="btn btn-primary px-4 mt-2"
                           style="background: linear-gradient(to right, red, #007bff); border: none;">
                            Join
                        </a>
                    {% endif %}
                
                    <!-- Angle arrow icon aligned to the right -->
                    <a href="{% url 'league-teams' league.league_code %}" class="text-primary" title="View Teams">
                        <i class="fas fa-angle-right fa-2x"></i>
                    </a>
                </div>
                
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">No public leagues available at the moment.</p>
            {% endif %}
        </div>
        {% else %}
    

        <!-- Player Selection -->
        <div class="col-md-4" id="targetDiv1">
            <div class="bg-white p-4 rounded shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold">Player Selection</h5>
                    <a href="javascript:void(0);" id="showDivLink" style="text-decoration: none; color: #5f3f85; font-size: 16px; font-weight: bold; display: flex; align-items: center;">
                        <span style="font-size: 18px; margin-right: 8px;">&#8592;</span> Back
                    </a>
                    
                </div>
                
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search for player...">
                <select id="viewFilter" class="form-select mb-3">
                    <option value="All">View</option>
                    <option value="Defenders">Defenders</option>
                    <option value="Midfielders">Midfielders</option>
                    <option value="Goalkeepers">Goalkeepers</option>
                    <option value="Forwards">Forwards</option>
                </select>

                <!-- <select class="form-select mb-3">
                    <option>Sorted by</option>
                    <option>Total points</option>
                    <option>Price</option>
                </select>
                <p class="fw-bold mb-1">Max cost: Between 3.9 and 7.2</p>
                <div class="d-flex justify-content-between">
                    <span>7.2</span>
                    <input type="range" class="form-range">
                </div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="fiveSeasons">
                    <label class="form-check-label" for="fiveSeasons">
                        Show Players who have been at their club for 5+ seasons
                    </label>
                </div> -->
                <button id="playerCountButton" class="btn btn-primary w-100 mt-3">0 players shown</button>

                <!-- Goalkeepers Section -->
                <div id="goalkeepersTable" class="w-100">
                    <h5 class="fw-bold text-dark mt-4"  style="font-size: 0.9rem;">Goalkeepers</h5>
                    <!-- <table class="table table-bordered align-middle rounded"> -->
                    <table
                        style="border-collapse: separate; border-spacing: 0; border-radius: 10px; overflow: hidden; border: 1px solid #ddd;"
                        class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-4"  style="font-size: 0.6rem;">Player</th>
                                <th style="font-size: 0.6rem;">Opponent</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Points</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Price</th>
                            </tr>
                        </thead>
                        <tbody id="goalkeepersTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Select a team to view players.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Defenders Section -->
                <div id="defendersTable" class="w-100">
                    <h5 class="fw-bold text-dark mt-4"  style="font-size: 0.9rem;">Defenders</h5>
                    <table
                        style="border-collapse: separate; border-spacing: 0; border-radius: 10px; overflow: hidden; border: 1px solid #ddd;"
                        class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-4"  style="font-size: 0.6rem;">Player</th>
                                <th style="font-size: 0.6rem;">Opponent</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Points</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Price</th>
                            </tr>
                        </thead>
                        <tbody id="defendersTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Select a team to view players.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Midfielders Section -->
                <div id="midfieldersTable" class="w-100">
                    <h5 class="fw-bold text-dark mt-4"  style="font-size: 0.9rem;">Midfielders</h5>
                    <table
                        style="border-collapse: separate; border-spacing: 0; border-radius: 10px; overflow: hidden; border: 1px solid #ddd;"
                        class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-4"  style="font-size: 0.6rem;">Player</th>
                                <th style="font-size: 0.6rem;">Opponent</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Points</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Price</th>
                            </tr>
                        </thead>
                        <tbody id="midfieldersTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Select a team to view players.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Forwards Section -->
                <div id="forwardsTable" class="w-100">
                    <h5 class="fw-bold text-dark mt-4"  style="font-size: 0.9rem;">Forwards</h5>
                    <table
                        style="border-collapse: separate; border-spacing: 0; border-radius: 10px; overflow: hidden; border: 1px solid #ddd;"
                        class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-4"  style="font-size: 0.6rem;">Player</th>
                                <th style="font-size: 0.6rem;">Opponent</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Points</th>
                                <th class="text-center"  style="font-size: 0.6rem;">Price</th>
                            </tr>
                        </thead>
                        <tbody id="forwardsTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Select a team to view players.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <span id="paginationInfo">1 of 76</span>
                    <div>
                        <button id="prevButton" class="btn btn-light me-2"><i class="fas fa-chevron-left"></i></button>
                        <button id="nextButton" class="btn btn-light"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}

    </div>

        
    <!-- Load Player to table -->
    <script>
  
        // Global Variables
        let allPlayers = []; // Store all players fetched from the API
        let filteredPlayers = []; // Players after applying search and filter
        let paginatedPlayers = []; // Players for the current page
        const pageSize = 10; // Players per page
        let currentPage = 1;
        let totalPages = 1;

        const tableBodies = {
                Goalkeepers: document.getElementById("goalkeepersTableBody"),
                Defenders: document.getElementById("defendersTableBody"),
                Midfielders: document.getElementById("midfieldersTableBody"),
                Forwards: document.getElementById("forwardsTableBody"),
        };
            
        const tables = {
                Goalkeepers: document.getElementById("goalkeepersTable"),
                Defenders: document.getElementById("defendersTable"),
                Midfielders: document.getElementById("midfieldersTable"),
                Forwards: document.getElementById("forwardsTable"),
        };



        // Update the table with players for the current page
        const updateTable = () => {
            Object.values(tableBodies).forEach((tableBody) => (tableBody.innerHTML = "")); // Clear all tables

            // Sort the players by price in descending order (highest to lowest)
            // const sortedPlayers = filteredPlayers.sort((a, b) => b.price - a.price);

            // Get players for the current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            paginatedPlayers = filteredPlayers.slice(startIndex, endIndex);

            const sortedPlayers = paginatedPlayers.sort((a, b) => b.price - a.price);

            let playerCount = 0;

            sortedPlayers.forEach((player) => {
                // data-playerid="${selectedPlayer.id}"
                // console.log(player)
                playerCount++;
                const row = `
                    <tr class="player-selection-row" 
                        data-name="${player.name}" 
                        data-image="${player.team_shirt}" 
                        data-team_shirt="${player.team_shirt}"
                        data-position="${player.position}" 
                        data-playerid="${player.id}"
                        data-price="${player.price}"
                        data-fixture="${player.fixture}"
                        data-form="${player.form || 'N/A'}"
                        data-tsb="${player.tsb || '0%'}"
                        data-team="${player.team}" 
                        data-teamlogo="${player.teamLogo}" 
                        data-fixture-team1="${player.fixture_data.team1}"
                        data-fixture-team1logo="${player.fixture_data.team1Logo}"
                        data-fixture-team2="${player.fixture_data.team2}"
                        data-fixture-team2logo="${player.fixture_data.team2Logo}"
                        data-fixture-time="${player.fixture_data.time}">
                        <td class="text-start ps-4">
                            <div class="d-flex align-items-center">
                                <img src="${player.team_shirt}" 
                                     alt="${player.name}" 
                                     class="me-3 rounded-circle" 
                                     style="width: 20px; height: 20px;" 
                                     onerror="this.onerror=null; this.src='{% static 'images/default3.png' %}';">
                                <div>
                                    <span class="fw-bold" style="font-size: 0.6rem;">${player.name}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge text-bg-warning" style="font-size: 0.6rem; color: white;">${player.fixture}</span></td>
                        <td class="text-center fw-bold" style="font-size: 0.6rem;">${player.total_points}</td>
                        <td class="text-center fw-bold" style="font-size: 0.6rem;">£${player.price}m</td>
                    </tr>`;

                const tableBody = tableBodies[player.position];
                if (tableBody) tableBody.innerHTML += row;
            });

            // Update player count and pagination info
            playerCountButton.textContent = `${playerCount} players shown`;
            paginationInfo.textContent = `${currentPage} of ${totalPages}`;
        };

        // Update pagination button states
        const updatePaginationButtons = () => {
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
        };

        // Toggle visibility of tables based on view filter
        const toggleTables = (selectedView) => {
            Object.keys(tables).forEach((position) => {
                if (selectedView === "All" || selectedView === position) {
                    tables[position].style.display = "table"; // Show the table
                } else {
                    tables[position].style.display = "none"; // Hide the table
                }
            });
        };

        // Apply search and view filters
        const applyFilters = (selectedView = viewFilter.value) => {
            const searchQuery = searchInput.value.toLowerCase();
            // const selectedView = viewFilter.value;

            // Filter all players based on search and view
            filteredPlayers = allPlayers.filter((player) => {
                const matchesSearch = player.name.toLowerCase().includes(searchQuery);
                const matchesView = selectedView === "All" || player.position === selectedView;
                return matchesSearch && matchesView;
            });

            // Reset pagination and update table
            totalPages = Math.ceil(filteredPlayers.length / pageSize);
            currentPage = 1;
            updateTable();
            updatePaginationButtons();
            toggleTables(selectedView); // Update table visibility
        };

        document.addEventListener("DOMContentLoaded", function () {
            // DOM Elements
            const playerCountButton = document.getElementById("playerCountButton");
            const prevButton = document.getElementById("prevButton");
            const nextButton = document.getElementById("nextButton");
            const paginationInfo = document.getElementById("paginationInfo");
            const searchInput = document.getElementById("searchInput");
            const viewFilter = document.getElementById("viewFilter");

            // Fetch all players
            const fetchAllPlayers = async () => {
                try {
                    // Show loading state
                    Object.values(tableBodies).forEach((tableBody) => {
                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center">Loading players...</td></tr>`;
                    });
                    playerCountButton.textContent = "Loading players...";

                    // Fetch players
                    const response = await fetch(`/api/get-all-players/`); // Replace with your endpoint for fetching all players
                    const data = await response.json();

                    if (response.ok && data.players) {
                        allPlayers = data.players; // Store all players globally
                        filteredPlayers = [...allPlayers]; // Initially, all players are included
                        totalPages = Math.ceil(filteredPlayers.length / pageSize);
                        currentPage = 1;

                        // Show the first page of results
                        updateTable();
                        updatePaginationButtons();
                    } else {
                        throw new Error("Failed to load players.");
                    }
                } catch (error) {
                    console.error("Error fetching players:", error);
                    Object.values(tableBodies).forEach((tableBody) => {
                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to load players.</td></tr>`;
                    });
                    playerCountButton.textContent = "Failed to load players.";
                }
            };


            // Event listeners for search and dropdown
            searchInput.addEventListener("input", () => {
                applyFilters();
            });

            viewFilter.addEventListener("change", () => {
                applyFilters();
            });

            // Event listeners for pagination buttons
            prevButton.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                    updatePaginationButtons();
                }
            });

            nextButton.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable();
                    updatePaginationButtons();
                }
            });

            // Initial fetch of all players
            fetchAllPlayers();
        });

    </script>

    <!-- Auto Selections -->
    <script>
        let pitchPlayersAuto = new Set(); // This tracks players on the pitch
        let usedPlayers = new Set(); // This tracks players that have already been picked (either on the pitch or as substitutes)
        let teamPlayerCount = {}; // To track the number of players selected from each team (both for pitch and substitutes)

        let totalBudget = 100.0; // Total available budget
        let remainingBudgetAuto = totalBudget; // Remaining budget
        let teamPresent = false;
        document.addEventListener("DOMContentLoaded", function () {
            // Define formations and their respective positions
            const formations = {
                    
                    "4-4-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "35%" },
                        { position: "Midfielders", top: "55%", left: "65%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "4-3-3": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "15%" },
                        { position: "Forwards", top: "75%", left: "50%" },
                        { position: "Forwards", top: "75%", left: "85%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "3-4-3": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "20%" },
                        { position: "Defenders", top: "35%", left: "80%" },
                        { position: "Defenders", top: "35%", left: "50%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "38%" },
                        { position: "Midfielders", top: "55%", left: "63%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "20%" },
                        { position: "Forwards", top: "75%", left: "50%" },
                        { position: "Forwards", top: "75%", left: "80%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ], 

                    "3-5-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "20%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "80%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "30%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "70%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ], 

                    "4-5-1": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "30%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "70%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "50%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],                    
                    
                    "5-3-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "30%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "70%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "5-4-1": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "30%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "70%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "38%" },
                        { position: "Midfielders", top: "55%", left: "63%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "50%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ]

                };
            
            const formationSelect = document.getElementById("formation-select");
            const pitchFormation = document.getElementById("pitch-formation");
            const autoPickButton = document.getElementById("autoPickButton");
            const budgetDisplay = document.getElementById("budgetDisplay");
            const favoriteClubId = "{{ favorite_club_id }}"; // Pass from backend

            let players = []; // Players will be dynamically populated

            // Fetch players dynamically based on teamId
            async function fetchPlayersByTeam(teamId) {
                try {
                    const response = await fetch(`/api/get-players-by-team/?team_id=${teamId}`);
                    const data = await response.json();
                    // console.log("Players fetched from API:", data.players);
                    if (data && data.players) {
                        players = data.players.map((player) => ({
                            id: player.id,
                            name: player.name,
                            position: player.position,
                            price: player.price,
                            form: player.form || "N/A",
                            total_points: player.total_points,
                            tsb: player.tsb || "0%",
                            fixture: player.fixture,
                            team: player.team,
                            team_short: player.team_short,
                            teamLogo: player.teamLogo,
                            image: player.image || "https://resources.premierleague.com/premierleague/photos/players/110x140/p204716.png", // Fallback image
                            team_shirt: player.team_shirt || "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_8-110.webp", // Fallback shirt
                            // Fixture Details
                            fixture_data: {
                                team1: player.fixture_data?.team1 || "Unknown",
                                team1Logo: player.fixture_data?.team1Logo,
                                team2: player.fixture_data?.team2 || "Unknown",
                                team2Logo: player.fixture_data?.team2Logo,
                                time: player.fixture_data?.time || "TBD"
                            },

                        }));
                        // console.log(players);
                        // window.sub_players = players;
                    } else {
                        console.error("No players found for the selected team.");
                    }
                } catch (error) {
                    console.error("Error fetching players:", error);
                }
            }

            // Update the budget display
            function updateBudgetDisplay() {
                budgetDisplay.textContent = `£${remainingBudgetAuto.toFixed(1)}m`;
            }

                        // Highlight selected pitch position
            const highlightPosition = (positionDiv, color = 'green') => {

            selectedPositionReplace = null;
            document.querySelectorAll(".pitch-position").forEach((div) => {
                div.style.border = ""; // Reset border for all positions
            });
            if (positionDiv) {
                positionDiv.style.border = `2px dashed ${color}`; // Highlight selected position
                selectedPositionElement = positionDiv;
            }
            };

            // Function to render a formation
            function renderFormation(formationKey) {
                pitchFormation.innerHTML = ""; // Clear the pitch
                const formation = formations[formationKey];

                if (formation) {
                    formation.forEach((slot, index) => {
                        const positionDiv = document.createElement("div");
                        positionDiv.className = "position-absolute text-center";
                        positionDiv.style.top = slot.top;
                        positionDiv.style.left = slot.left;
                        positionDiv.style.transform = "translate(-50%, -50%)";

                        // Shortened position names for small screens
                        const shortPositions = {
                            "Goalkeepers": "GPK",
                            "Defenders": "DEFF",
                            "Midfielders": "MID",
                            "Forwards": "FWD"
                        };

                        // Detect screen width
                        const isSmallScreen = window.innerWidth <= 576;
                        const positionText = isSmallScreen ? shortPositions[slot.position] || slot.position : slot.position;

                        // Conditionally apply a white border if the slot count is greater than 10
                        if (index > 10) {
                            positionDiv.style.border = "1px solid white";  // Add white border
                            positionDiv.style.borderRadius = "10px";  // Add rounded corners
                        }

                        positionDiv.innerHTML = `
                            <div class="position-card d-flex justify-content-center align-items-center auto-reset-button ">
                                <div class="position-content">
                                    <i class="fas fa-user-plus"></i> <!-- User Icon -->
                                    <span>${positionText}</span>
                                </div>
                            </div>
                        `;

                        // Add click event to highlight the position
                        positionDiv.addEventListener("click", () => {

                            // Check if the screen width is small (<= 768px)
                            if (window.innerWidth <= 768) {
                                    var targetDiv = document.getElementById("targetDiv");
                                    var targetDiv1 = document.getElementById("targetDiv1");
                                    targetDiv.style.display = "none"; // Show the div
                                    targetDiv1.style.display = "block"; // Show the div
                            }

                            applyFilters(positionText);
                        });

                        pitchFormation.appendChild(positionDiv);
                    });
                }

                // Update positions dynamically when screen resizes
                window.addEventListener("resize", () => {
                    document.querySelectorAll(".position-content span").forEach((span) => {
                        const fullText = {
                            "GPK": "Goalkeepers",
                            "DEFF": "Defenders",
                            "MID": "Midfielders",
                            "FWD": "Forwards"
                        };
                        const shortText = {
                            "Goalkeepers": "GPK",
                            "Defenders": "DEFF",
                            "Midfielders": "MID",
                            "Forwards": "FWD"
                        };

                        const isSmallScreen = window.innerWidth <= 576;
                        span.textContent = isSmallScreen ? shortText[span.textContent] || span.textContent : fullText[span.textContent] || span.textContent;
                    });
                });

            }

             // Auto-pick players while considering the budget
            function autoPickPlayers(formationKey) {
                const formation = formations[formationKey];
                if (!formation) {
                    console.error("Formation not found:", formationKey);
                    return;
                }

                // Group players by position
                const groupedPlayers = {};
                players.forEach((player) => {
                    if (!groupedPlayers[player.position]) {
                        groupedPlayers[player.position] = [];
                    }
                    groupedPlayers[player.position].push(player);
                });

                // Shuffle players in each position group
                Object.keys(groupedPlayers).forEach((position) => {
                    groupedPlayers[position] = groupedPlayers[position].sort(() => 0.5 - Math.random());
                });

                remainingBudgetAuto = totalBudget; // Reset budget
                updateBudgetDisplay();
                pitchFormation.innerHTML = ""; // Clear the pitch

                // Track used players to avoid duplicates
                // const usedPlayers = new Set();
                // const teamPlayerCount = {}; // Track number of players selected for each team

                formation.forEach((slot) => {
                    if (!groupedPlayers[slot.position] || groupedPlayers[slot.position].length === 0) {
                        console.warn("No players available for position:", slot.position);
                        return;
                    }

                    // Get a unique player within budget and team constraints
                    let selectedPlayer = null;
                    for (let i = 0; i < groupedPlayers[slot.position].length; i++) {
                        const potentialPlayer = groupedPlayers[slot.position][i];

                        // Skip players that are already selected
                        if (usedPlayers.has(potentialPlayer.name)) continue;

                        // Check if the team already has 3 players selected
                        if (teamPlayerCount[potentialPlayer.team] && teamPlayerCount[potentialPlayer.team] >= 3) {
                            continue; // Skip this player if their team already has 3 players selected
                        }

                        if (potentialPlayer.price <= remainingBudgetAuto) {
                            selectedPlayer = potentialPlayer;
                            usedPlayers.add(selectedPlayer.name); // Mark as used
                            remainingBudgetAuto -= selectedPlayer.price; // Deduct budget

                            // Update team player count
                            teamPlayerCount[potentialPlayer.team] = (teamPlayerCount[potentialPlayer.team] || 0) + 1;
                            break;
                        }
                    }

                    if (!selectedPlayer) {
                        console.warn("No affordable player for position:", slot.position);
                        return;
                    }

                    // Create player card
                    const playerDiv = document.createElement("div");
                    playerDiv.className = "position-absolute text-center";
                    playerDiv.style.top = slot.top;
                    playerDiv.style.left = slot.left;
                    playerDiv.style.transform = "translate(-50%, -50%)";

                    // Default images categorized by position
                    const defaultImagesByPosition = {
                        "Goalkeepers": [
                            "https://resources.premierleague.com/premierleague/photos/players/110x140/p463748.png",
                            "https://resources.premierleague.com/premierleague/photos/players/110x140/p462492.png",
                            "https://resources.premierleague.com/premierleague/photos/players/110x140/p248164.png"
                        ],
                        "Defenders": [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_31-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_14-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_91-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_11-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_39-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_8-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_1-66.webp"
                        ],
                        "Midfielders": [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_31-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_14-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_91-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_11-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_39-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_8-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_1-66.webp"
                        ],
                        "Forwards": [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_31-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_14-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_91-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_11-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_39-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_8-66.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_1-66.webp"
                        ]
                    };

                    // Function to get a random default image based on player position
                    function getRandomDefaultImage(position) {
                        const images = defaultImagesByPosition[position] || [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_11-66.webp"
                        ]; // Fallback to a general default image if position not found
                        return images[Math.floor(Math.random() * images.length)];
                    }

                    // Determine the final image source before rendering
                    const finalImage = selectedPlayer.team_shirt ? selectedPlayer.team_shirt : getRandomDefaultImage(selectedPlayer.position);

                    playerDiv.innerHTML = `
                        <div class="rounded text-center shadow-sm position-relative player-card-save" 
                            style="font-family: Arial, sans-serif; cursor: pointer;"  
                            data-name="${selectedPlayer.name}" 
                            data-playerid="${selectedPlayer.id}"
                            data-image="${selectedPlayer.team_shirt}" 
                            data-position="${selectedPlayer.position}"
                            data-price="${selectedPlayer.price}" 
                            data-team_shirt="${selectedPlayer.team_shirt}"
                            data-form="${selectedPlayer.form || 'N/A'}"
                            data-tsb="${selectedPlayer.tsb || '0%'}"
                            data-team="${selectedPlayer.team}" 
                            data-teamlogo="${selectedPlayer.teamLogo}" 
                            data-fixture-team1="${selectedPlayer.fixture_data.team1}"
                            data-fixture-team1logo="${selectedPlayer.fixture_data.team1Logo}"
                            data-fixture-team2="${selectedPlayer.fixture_data.team2}"
                            data-fixture-team2logo="${selectedPlayer.fixture_data.team2Logo}"
                            data-fixture-time="${selectedPlayer.fixture_data.time}">

                            <!-- Image as Background -->
                            <div class="position-relative">
                                <div class="price-tag">
                                    £${selectedPlayer.price}
                                </div>
                                <img src="${finalImage}" 
                                    alt="${selectedPlayer.name.split(" ")[0]}" 
                                    onerror="this.onerror=null; this.src='${getRandomDefaultImage(selectedPlayer.position)}'; this.parentElement.parentElement.setAttribute('data-image', this.src);" 
                                    class="player-image">
                                
                                <!-- First Overlayed Text (Positioned at Bottom) -->
                                <div class="bg-white position-absolute w-100 text-center" 
                                    style="bottom: 18px; left: 0; font-size: 0.6rem; font-weight: bold; color: #4A4A4A; padding: 3px; z-index: 2; background: rgba(255, 255, 255, 0.8);">
                                    ${selectedPlayer.name.split(" ")[0]}
                                </div>

                                <!-- Second Overlayed Text (Directly Below the First) -->
                                <div class="position-absolute w-100 text-center" 
                                    style="bottom: 0px; left: 0; font-size: 0.5rem; font-weight: bold; color: #000033; padding: 3px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; z-index: 3; background: rgb(184,184,184);">
                                    ${selectedPlayer.fixture} <!-- Example field for upcoming fixture -->
                                </div>
                            </div>
                        </div>
                    `;

                            // Add click event to open the modal
                    playerDiv.querySelector(".player-card-save").addEventListener("click", function () {
                        showPlayerModal(
                            this.getAttribute("data-name"), 
                            this.getAttribute("data-playerid"),
                            this.getAttribute("data-image"),
                            this.getAttribute("data-position"),
                            this.getAttribute("data-price") || "£0.0m",
                            this.getAttribute("data-form") || "N/A",
                            this.getAttribute("data-tsb") || "0%",
                            this.getAttribute("data-team") || "Unknown Team",
                            this.getAttribute("data-teamlogo"),
                            {
                                team1: this.getAttribute("data-fixture-team1") || "Team A",
                                team1Logo: this.getAttribute("data-fixture-team1logo"),
                                team2: this.getAttribute("data-fixture-team2") || "Team B",
                                team2Logo: this.getAttribute("data-fixture-team2logo"),
                                time: this.getAttribute("data-fixture-time") || "TBD"
                            }
                        );
                    });


                    // Add player to the pitch
                    pitchFormation.appendChild(playerDiv);
                    updateBudgetDisplay();
                });
            }

        function showPlayerModal(name, playerId, image, position, price, form, tsb, team, teamLogo, fixture) {
            const modal = document.getElementById("playerModal");

            const makeCaptainButton = document.getElementById("makeCaptainButton");
            const makeViceCaptainButton = document.getElementById("makeViceCaptainButton");
            const transferOutButton = document.getElementById("transferOutButton");
            const switchOutButton = document.getElementById("switchOutButton");

            transferOutButton.style.display = "none";
            switchOutButton.style.display = "none";
            makeCaptainButton.style.display = "none";  // Hide Make Captain button
            makeViceCaptainButton.style.display = "none";  // Hide Make Vice Captain button

            // console.log(fixture);
            // Check if modal exists
            if (!modal) {
                console.error("Modal element not found!");
                return;
            }

            // Set player details
            document.getElementById("modalPlayerName").textContent = name;
            document.getElementById("modalPlayerImage").src = image;
            document.getElementById("modalPlayerImage").onerror = function () {
                this.onerror = null;
                this.src = "https://via.placeholder.com/80"; // Fallback image
            };
            document.getElementById("modalPlayerPosition").textContent = position;
            document.getElementById("modalPlayerPrice").textContent = "£" + price + "m";
            document.getElementById("modalPlayerForm").textContent = form;
            document.getElementById("modalPlayerTSB").textContent = tsb;
            document.getElementById("modalTeamName").textContent = team;
            document.getElementById("modalTeamLogo").src = teamLogo;
            document.getElementById("modalPlayerImage").setAttribute("data-playerid", playerId);
            document.getElementById("modalTeamLogo").onerror = function () {
                this.onerror = null;
                this.src = "{% static 'images/default3.png' %}"; // Fallback team logo
            };

            // **Convert fixture?.time to a formatted date**
            let fixtureDate = "TBD"; // Default if no date is provided
            if (fixture && fixture?.time && fixture?.time !== "TBD") {
                try {
                    let dateObj = new Date(fixture?.time);
                    let options = { weekday: "long", day: "numeric", month: "long" };
                    fixtureDate = dateObj.toLocaleDateString("en-GB", options); // Example: "Saturday 15 February"
                } catch (error) {
                    console.error("Error parsing fixture time:", error);
                }
            }

            // Set fixture details
            document.getElementById("fixtureTeam1Name").textContent = fixture?.team1 || "Team A";
            document.getElementById("fixtureTeam1Logo").src = fixture?.team1Logo;
            document.getElementById("fixtureTeam1Logo").onerror = function () {
                this.onerror = null;
                this.src = "{% static 'images/default3.png' %}"; // Fallback team1 logo
            };

            document.getElementById("fixtureTeam2Name").textContent = fixture?.team2 || "Team B";
            document.getElementById("fixtureTeam2Logo").src = fixture?.team2Logo;
            document.getElementById("fixtureTeam2Logo").onerror = function () {
                this.onerror = null;
                this.src = "{% static 'images/default3.png' %}"; // Fallback team2 logo
            };

                // Hide team2Logo if the team name is "Unknown"
            if (fixture?.team2 === "Unknown" || fixture?.team2 === "None") {
                document.getElementById("fixtureTeam2Logo").style.display = "none";  // Hide logo
            } else {
                document.getElementById("fixtureTeam2Logo").style.display = "inline"; // Show logo
            }
            
            document.getElementById("fixtureTime").textContent = fixtureDate; // Now dynamically formatted
            document.getElementById("fixtureDate").textContent = fixtureDate;

            // Show modal
            modal.style.display = "block";
        }

            document.getElementById("closeModalButton").addEventListener("click", function () {
                document.getElementById("playerModal").style.display = "none";
            });

            document.getElementById("playerModal").addEventListener("click", function (e) {
                if (e.target === this) {
                    this.style.display = "none";
                }
            });
            
            formationSelect.addEventListener("change", function () {
                const hidesubscontainer = document.getElementById("subs-container");
                hidesubscontainer.style.display = "none";
                renderFormation(this.value);
            });

            // Execute renderFormation on load with the currently selected value or a default
            // renderFormation("4-3-3");

            autoPickButton.addEventListener("click", function () {
                const hidesubscontainer = document.getElementById("subs-container");
                hidesubscontainer.style.display = "block";
                pitchPlayersAuto.clear();
                usedPlayers.clear();
                teamPlayerCount = Object.create(null); // Ensure fresh reference
                
                autoPickPlayers(formationSelect.value); // Trigger auto-pick based on the current formation
            });

            async function initializeTeam(favoriteClubId) {
                try {
                    // Fetch players by team
                    await fetchPlayersByTeam(favoriteClubId);

                    // Fetch team status
                    const response = await fetch("/api/check-team-status/", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        throw new Error("Failed to fetch team status.");
                    }

                    const data = await response.json();

                    if (!data.team_exists) {
                        renderFormation("4-4-2"); // Render the default formation
                        updateBudgetDisplay(); // Initialize budget display
                        // console.log('Sangulo');
                    }else{ 

                        // Construct URL based on user_id
                        let url = "/api/get-saved-team/";
                        fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        })
                        .then((response) => {
                            if (response.ok) return response.json();
                            throw new Error("Failed to fetch saved team.");
                        })
                        .then((data) => {
                            // console.log("Fetched data:", data);

                            const current_gameweek= document.getElementById("current_gameweek").textContent.trim();

                            // Filter the players where gameweek is 27
                            const playersInGameweek = data.team.filter(player => player.gameweek === parseInt(current_gameweek,0));

                            // Check if there are any players for the specific gameweek
                            if (!playersInGameweek.length > 0) {
                                renderFormation("4-4-2"); // Render the default formation
                                updateBudgetDisplay(); // Initialize budget display
                            }else{
                                 teamPresent = true;
                            }
                        })
                        .catch((error) => {
                            console.error("Error loading saved team:", error);
                        });

                    }

                } catch (error) {
                    console.error("Error initializing team:", error);
                }
            }

            // Usage
            fetchPlayersByTeam(favoriteClubId).then(() => {
                initializeTeam(favoriteClubId);
            });

            
        });


    </script>

    <!-- Manual Selections -->
    <script>
        // Declare pitchPlayers globally, before any scripts
        let pitchPlayers = new Set(); // This will track players already assigned to the pitch
        let usedSubsPlayers = new Set(); // This will track players already assigned to the substitutes
        let playerSection = 0;
        let teamCounts = {}; // Track the number of selected players per team
        let remainingBudget = 100; // Total budget in millions
        let selectedPositionElement;
        let playerIdRemoved = 0;
        let teamPlayerIdRemoved = 0;
        let RemovedPlayerPrice = 0;
        let ReplaceLocationChanger = 0;
        let selectedPlayers = new Set(); // To keep track of selected player IDs

        document.addEventListener("DOMContentLoaded", function () {
            const pitchFormation = document.getElementById("pitch-formation");
            
            const tableBodies = {
                Goalkeepers: document.getElementById("goalkeepersTableBody"),
                Defenders: document.getElementById("defendersTableBody"),
                Midfielders: document.getElementById("midfieldersTableBody"),
                Forwards: document.getElementById("forwardsTableBody"),
            };
            const budgetDisplay = document.getElementById("budgetDisplay");
            const formationSelect = document.getElementById("formation-select");
            const resetButton = document.getElementById("resetButton");
            const AutoResetButton = document.getElementById("AutoResetButton");
            const autoPickButton = document.getElementById("autoPickButton");

            selectedPositionElement = null; // Currently selected pitch position
            // let remainingBudget = 100; // Total budget in millions

            // Update budget display
            const updateBudgetDisplay = () => {
                budgetDisplay.textContent = `£${remainingBudget.toFixed(1)}m`;
            };

            // Highlight selected pitch position
            const highlightPosition = (positionDiv, color = 'green') => {

                selectedPositionReplace = null;
                document.querySelectorAll(".pitch-position").forEach((div) => {
                    div.style.border = ""; // Reset border for all positions
                });
                if (positionDiv) {
                    positionDiv.style.border = `2px dashed ${color}`; // Highlight selected position
                    selectedPositionElement = positionDiv;
                }
            };

            // Render formation on the pitch
            const renderFormation = (formationKey) => {
                pitchFormation.innerHTML = ""; // Clear the pitch

                const formations = {
                    
                    "4-4-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "35%" },
                        { position: "Midfielders", top: "55%", left: "65%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "4-3-3": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "15%" },
                        { position: "Forwards", top: "75%", left: "50%" },
                        { position: "Forwards", top: "75%", left: "85%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "3-4-3": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "20%" },
                        { position: "Defenders", top: "35%", left: "80%" },
                        { position: "Defenders", top: "35%", left: "50%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "38%" },
                        { position: "Midfielders", top: "55%", left: "63%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "20%" },
                        { position: "Forwards", top: "75%", left: "50%" },
                        { position: "Forwards", top: "75%", left: "80%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ], 

                    "3-5-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "20%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "80%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "30%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "70%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ], 

                    "4-5-1": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "30%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "70%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "50%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],                    
                    
                    "5-3-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "30%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "70%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "5-4-1": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "30%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "70%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "38%" },
                        { position: "Midfielders", top: "55%", left: "63%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "50%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ]

                };
                
                const formation = formations[formationKey];
                if (formation) {
                    formation.forEach((slot, index) => {
                        const positionDiv = document.createElement("div");
                        positionDiv.className = "pitch-position position-absolute text-center";
                        positionDiv.style.top = slot.top;
                        positionDiv.style.left = slot.left;
                        positionDiv.style.transform = "translate(-50%, -50%)";
                        positionDiv.setAttribute("data-index", index);
                        positionDiv.setAttribute("data-position", slot.position);

                        // Conditionally apply a white border if the slot count is greater than 10
                        if (index > 10) {
                            positionDiv.style.border = "1px solid white";  // Add white border
                            positionDiv.style.borderRadius = "10px";  // Add rounded corners
                        }

                        positionDiv.innerHTML = `
                            <div class="position-card d-flex justify-content-center align-items-center">
                                <div class="position-content">
                                    <i class="fas fa-user-plus"></i> <!-- User Icon -->
                                    <span>${slot.position}</span>
                                </div>
                            </div>
                        `;

                        // Add click event to highlight the position
                        positionDiv.addEventListener("click", () => {
                            playerSection=2;
                            ReplaceLocationChanger = 1;
                            // console.log(teamCounts);
                            // console.log(teamCounts)
                            // console.log(pitchPlayers)
                            highlightPosition(positionDiv);
                            // console.log("Position clicked:", positionDiv.getAttribute('data-position'));
                            

                            // Check if the screen width is small (<= 768px)
                            if (window.innerWidth <= 768) {
                                var targetDiv = document.getElementById("targetDiv");
                                var targetDiv1 = document.getElementById("targetDiv1");
                                targetDiv.style.display = "none"; // Show the div
                                targetDiv1.style.display = "block"; // Show the div
                            }

                            applyFilters(positionDiv.getAttribute('data-position'));
                        });

                        pitchFormation.appendChild(positionDiv);
                    });
                }
            }; 

            // Assign player to position
            const assignPlayerToPosition = (player) => {
              
                if (!selectedPositionElement && playerSection===0) {
                    // alert("Please select a position on the pitch first!");
                    showToast(`Please select a position on the pitch first!`, "warning");
                    return;
                }

                // Count players from the same team
                if (!teamCounts[player.team]) {
                    teamCounts[player.team] = 0;
                }

                // 🚨 **Check if team already has 3 players**
                if (teamCounts[player.team] >= 3) {
                    // alert(`You cannot select more than 3 players from ${player.team}!`);
                    showToast(`You cannot select more than 3 players from ${player.team}!`, "warning");
                    return; // Prevent selection
                }

                if (selectedPlayers.has(player.id)) {
                    // Show toast message for already selected player
                    showToast(`${player.name} has already been selected!`, "warning");
                    return; // Prevent selecting the same player again
                }

                const playerPrice = parseFloat(player.price);
                if (remainingBudget < playerPrice) {
                    // Show toast message for insufficient budget
                    showToast("Insufficient budget to add this player!", "warning");
                    return;
                }

             if(playerSection===2){                
                // Deduct player price from the budget
                remainingBudget -= playerPrice;
                selectedPlayers.add(player.id);

                // console.log("Section "+playerSection);
                pitchPlayers.add(player.id);// Mark player as used in substitutes

                // console.log(pitchPlayers.size);
                if (pitchPlayers.size === 11) {
                    // showToast(`Please select all the pitch players first!`, "warning");
                    // return;
                    const hidesubscontainer = document.getElementById("subs-container");
                    hidesubscontainer.style.display = "block";
                }

                // ✅ **Update team count**
                teamCounts[player.team]++;

                updateBudgetDisplay();
                selectedPositionElement.innerHTML = `
                    <div class="rounded text-center shadow-sm position-relative player-card-save" 
                        style="font-family: Arial, sans-serif; cursor: pointer;"  
                        data-name="${player.name}" 
                        data-playerid="${player.id}"
                        data-image="${player.team_shirt}" 
                        data-position="${player.position}"  
                        data-price="${player.price}"
                        data-team_shirt="${player.team_shirt}"
                        data-fixture="${player.fixture}"
                        data-form="${player.form || 'N/A'}"
                        data-tsb="${player.tsb || '0%'}"
                        data-team="${player.team}" 
                        data-teamlogo="${player.teamLogo}" 
                        data-fixture-team1="${player.team1}"
                        data-fixture-team1logo="${player.team1Logo}"
                        data-fixture-team2="${player.team2}"
                        data-fixture-team2logo="${player.team2Logo}"
                        data-fixture-time="${player.time}">

                        <!-- Image as Background -->
                        <div class="position-relative">
                            <div class="price-tag">
                                £${player.price}
                            </div>
                            <img src="${player.image}" 
                                alt="${player.name.split(' ')[0]}" 
                                onerror="this.onerror=null; this.src='{% static 'images/default3.png' %}'; this.parentElement.parentElement.setAttribute('data-image', this.src);" 
                                class="player-image">
                            
                            <!-- First Overlayed Text (Positioned at Bottom) -->
                            <div class="bg-white position-absolute w-100 text-center" 
                                style="bottom: 18px; left: 0; font-size: 0.6rem; font-weight: bold; color: #4A4A4A; padding: 3px; z-index: 2; background: rgba(255, 255, 255, 0.8);">
                                ${player.name.split(" ")[0]}
                            </div>

                            <!-- Second Overlayed Text (Directly Below the First) -->
                            <div class="position-absolute w-100 text-center" 
                                style="bottom: 0px; left: 0; font-size: 0.5rem; font-weight: bold; color: #000033; padding: 3px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; z-index: 3; background: rgb(184,184,184);">
                                ${player.fixture}
                            </div>
                        </div>
                    </div>

                `;


                // Add click event to the new player card for modal functionality
                selectedPositionElement.querySelector(".player-card-save").addEventListener("click", function (e) {
                    // e.stopPropagation(); // Prevent event bubbling
                    playerIdRemoved = this.getAttribute("data-playerid");
                    teamPlayerIdRemoved = this.getAttribute("data-team");
                    RemovedPlayerPrice = this.getAttribute("data-price");
                    showPlayerModal(
                            this.getAttribute("data-name"), 
                            this.getAttribute("data-playerid"),
                            this.getAttribute("data-image"),
                            this.getAttribute("data-position"),
                            this.getAttribute("data-price") || "£0.0m",
                            this.getAttribute("data-form") || "N/A",
                            this.getAttribute("data-tsb") || "0%",
                            this.getAttribute("data-team") || "Unknown Team",
                            this.getAttribute("data-teamlogo"),
                            {
                                team1: this.getAttribute("data-fixture-team1") || "Team A",
                                team1Logo: this.getAttribute("data-fixture-team1logo"),
                                team2: this.getAttribute("data-fixture-team2") || "Team B",
                                team2Logo: this.getAttribute("data-fixture-team2logo"),
                                time: this.getAttribute("data-fixture-time") || "TBD"
                            }
                        );
                });


                }
                playerSection=0;

                // console.log(usedSubsPlayers);
                // console.log('Gap');
                // console.log(pitchPlayers);



                selectedPositionElement = null; // Reset selected position
            };

            // **Remove player and update team count**
            const removePlayer = (playerId, team, playerPrice) => {
                if (selectedPlayers.has(playerId)) {
                    selectedPlayers.delete(playerId);
                    pitchPlayers.delete(playerId);

                    // Readd player price from the budget
                    remainingBudget += Number(playerPrice);
                    updateBudgetDisplay();

                    if (teamCounts[team]) {
                        teamCounts[team]--; // Reduce the count
                    }
                }
            };

                    // Show modal with player details
        function showPlayerModal(name, playerId, image, position, price, form, tsb, team, teamLogo, fixture) {
            const modal = document.getElementById("playerModal");
            const makeCaptainButton = document.getElementById("makeCaptainButton");
            const makeViceCaptainButton = document.getElementById("makeViceCaptainButton");
            const transferOutButton = document.getElementById("transferOutButton");

            transferOutButton.style.display = "block";
            switchOutButton.style.display = "block";
            makeCaptainButton.style.display = "none";  // Hide Make Captain button
            makeViceCaptainButton.style.display = "none";  // Hide Make Vice Captain button
            // console.log(fixture);
            // Check if modal exists
            if (!modal) {
                console.error("Modal element not found!");
                return;
            }

            // Set player details
            document.getElementById("modalPlayerName").textContent = name;
            document.getElementById("modalPlayerImage").src = image;
            document.getElementById("modalPlayerImage").onerror = function () {
                this.onerror = null;
                this.src = "https://via.placeholder.com/80"; // Fallback image
            };
            document.getElementById("modalPlayerPosition").textContent = position;
            document.getElementById("modalPlayerPrice").textContent = "£" + price + "m";
            document.getElementById("modalPlayerForm").textContent = form;
            document.getElementById("modalPlayerTSB").textContent = tsb;
            document.getElementById("modalTeamName").textContent = team;
            document.getElementById("modalTeamLogo").src = teamLogo;
            document.getElementById("modalPlayerImage").setAttribute("data-playerid", playerId);
            document.getElementById("modalTeamLogo").onerror = function () {
                this.onerror = null;
                this.src = "{% static 'images/default3.png' %}"; // Fallback team logo
            };

            // **Convert fixture?.time to a formatted date**
            let fixtureDate = "TBD"; // Default if no date is provided
            if (fixture && fixture?.time && fixture?.time !== "TBD") {
                try {
                    let dateObj = new Date(fixture?.time);
                    let options = { weekday: "long", day: "numeric", month: "long" };
                    fixtureDate = dateObj.toLocaleDateString("en-GB", options); // Example: "Saturday 15 February"
                } catch (error) {
                    console.error("Error parsing fixture time:", error);
                }
            }

            // Set fixture details
            document.getElementById("fixtureTeam1Name").textContent = fixture?.team1 || "Team A";
            document.getElementById("fixtureTeam1Logo").src = fixture?.team1Logo;
            document.getElementById("fixtureTeam1Logo").onerror = function () {
                this.onerror = null;
                this.src = "{% static 'images/default3.png' %}"; // Fallback team1 logo
            };

            document.getElementById("fixtureTeam2Name").textContent = fixture?.team2 || "Team B";
            document.getElementById("fixtureTeam2Logo").src = fixture?.team2Logo;
            document.getElementById("fixtureTeam2Logo").onerror = function () {
                this.onerror = null;
                this.src = "{% static 'images/default3.png' %}"; // Fallback team2 logo
            };

                // Hide team2Logo if the team name is "Unknown"
            if (fixture?.team2 === "Unknown" || fixture?.team2 === "None") {
                document.getElementById("fixtureTeam2Logo").style.display = "none";  // Hide logo
            } else {
                document.getElementById("fixtureTeam2Logo").style.display = "inline"; // Show logo
            }
            
            document.getElementById("fixtureTime").textContent = fixtureDate; // Now dynamically formatted
            document.getElementById("fixtureDate").textContent = fixtureDate;

            // Show modal
            modal.style.display = "block";
        }


        // Close the modal
        document.getElementById("closeModalButton").addEventListener("click", function () {
            // Hide the modal
            document.getElementById("playerModal").style.display = "none";

            // Check if there's a previously selected position and reset its border
            if (selectedPositionElement) {
                selectedPositionElement.style.border = ""; // Reset the border
                selectedPositionElement = null; // Clear the reference to the selected position
            }
        });



        document.getElementById("transferOutButton").addEventListener("click", function () {
            if (ReplaceLocationChanger === 1){
                document.getElementById("playerModal").style.display = "none";
            if (selectedPositionElement) {

                // Call the removePlayer function to remove the player from the set
                removePlayer(playerIdRemoved, teamPlayerIdRemoved, RemovedPlayerPrice);

                // console.log(teamCounts)
                // console.log(pitchPlayers)
                // console.log(playerIdRemoved)
                // console.log(teamPlayerIdRemoved)
                // console.log(selectedPositionElement)

                // Remove the player from the slot
                selectedPositionElement.innerHTML = `
                    <div class="position-card d-flex justify-content-center align-items-center">
                        <div class="position-content">
                            <i class="fas fa-user-plus"></i> <!-- User Icon -->
                            <span>${selectedPositionElement.getAttribute('data-position')}</span>
                        </div>
                    </div>
                `; // Resetting the HTML to default no player state

                // selectedPositionElement.style.border = "2px solid red"; // Using red for replacement indication
                highlightPosition(selectedPositionElement, 'red');

                // Resetting selectedPositionElement to ensure no selection is retained after replacement
            } else {
                console.log("No position selected.");
                alert("Please select a position on the pitch to replace a player.");
            } }
        });
    
            // Handle manual player selection
            Object.values(tableBodies).forEach((tableBody) => {
                tableBody.addEventListener("click", (event) => {
                    const row = event.target.closest(".player-selection-row");
                    // Check if the screen width is small (<= 768px)
                    if (window.innerWidth <= 768) {
                        var targetDiv = document.getElementById("targetDiv");
                        var targetDiv1 = document.getElementById("targetDiv1");
                        targetDiv.style.display = "block"; // Show the div
                        targetDiv1.style.display = "none"; // Show the div
                    }
                    if (!row) return;

                    const player = {
                        id: row.getAttribute("data-playerid"),
                        name: row.getAttribute("data-name"),
                        image: row.getAttribute("data-image"),
                        team_shirt: row.getAttribute("data-team_shirt"),
                        position: row.getAttribute("data-position"),
                        price: row.getAttribute("data-price"),
                        fixture: row.getAttribute("data-fixture"),
                        form: row.getAttribute("data-form") || "N/A",
                        tsb: row.getAttribute("data-tsb") || "0%",
                        team: row.getAttribute("data-team") || "Unknown Team",
                        teamLogo: row.getAttribute("data-teamlogo"),
                        team1: row.getAttribute("data-fixture-team1") || "Team A",
                        team1Logo: row.getAttribute("data-fixture-team1logo"),
                        team2: row.getAttribute("data-fixture-team2") || "Team B",
                        team2Logo: row.getAttribute("data-fixture-team2logo"),
                        time: row.getAttribute("data-fixture-time") || "TBD"
                    };

                    // console.log(player);

                    assignPlayerToPosition(player);
                });
            });

            const hidesubscontainer = document.getElementById("subs-container");
            
            // Reset button functionality
            resetButton.addEventListener("click", () => {
                // Clear all global tracking variables
                hidesubscontainer.style.display = "none";
                pitchPlayers.clear();
                usedSubsPlayers.clear();
                teamCounts = Object.create(null); // Ensure fresh reference
                playerSection = 0;
                selectedPlayers.clear();
                renderFormation(formationSelect.value); // Re-render formation
                remainingBudget = 100; // Reset budget
                updateBudgetDisplay();
            });

            document.getElementById('pitch-formation').addEventListener('click', function(event) {
                // Check if the clicked element or any of its parents have the 'auto-reset-button' class
                const target = event.target.closest('.auto-reset-button');
                if (target) {
                    // console.log('Clicked Okobo:', target.querySelector('span').textContent);
                    // Any other logic you want to execute on click

                    // Clear all global tracking variables
                    pitchPlayers.clear();
                    usedSubsPlayers.clear();
                    teamCounts = Object.create(null); // Ensure fresh reference
                    playerSection = 0;
                    selectedPlayers.clear();
                    renderFormation(formationSelect.value); // Re-render formation
                    remainingBudget = 100; // Reset budget
                    updateBudgetDisplay();
                    }
            });

            // Formation dropdown change event
            formationSelect.addEventListener("change", function () {
                renderFormation(this.value); // Re-render formation based on dropdown selection
            });

            // Render default formation on load
            // renderFormation(formationSelect.value);

            // Initialize budget display
            updateBudgetDisplay();
        });
    
    </script>

    <!-- Showing Toast -->
    <script>
        function showToast(message, type = "danger") {
            const toastContainer = document.getElementById("toastContainer");

            // Create the toast element
            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute("role", "alert");
            toast.setAttribute("aria-live", "assertive");
            toast.setAttribute("aria-atomic", "true");
            toast.setAttribute("data-bs-autohide", "true");
            toast.setAttribute("data-bs-delay", "3000");

            // Add the toast content
            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

            // Append the toast to the container
            toastContainer.appendChild(toast);

            // Initialize the toast using Bootstrap's JS
            const bootstrapToast = new bootstrap.Toast(toast);
            bootstrapToast.show();

            // Remove the toast from the DOM after it hides
            toast.addEventListener("hidden.bs.toast", () => {
                toast.remove();
            });
        }

    </script>

    <!-- Team Saving -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const saveTeamButton = document.getElementById("saveTeamButton");

            // Fetch team status on page load
            fetch("/api/check-team-status/", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error("Failed to fetch team status.");
                })
                .then((data) => {
                        // Construct URL based on user_id
                        let url = "/api/get-saved-team/";
                        fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        })
                        .then((response) => {
                            if (response.ok) return response.json();
                            throw new Error("Failed to fetch saved team.");
                        })
                        .then((data) => {
                            // console.log("Fetched data:", data);
                            const current_gameweek= document.getElementById("current_gameweek").textContent.trim();

                            // Filter the players where gameweek is 27
                            const playersInGameweek = data.team.filter(player => player.gameweek === parseInt(current_gameweek,0));

                            // Check if there are any players for the specific gameweek
                            if (playersInGameweek.length > 0) {
                                // Disable the save button if the team already exists
                                saveTeamButton.disabled = true;
                                saveTeamButton.textContent = "Team Saved";
                                saveTeamButton.classList.add("btn-secondary"); // Optional: Update button styling
                                saveTeamButton.classList.remove("btn-primary");

                                // Disable the Auto Pick and Reset buttons
                                autoPickButton.disabled = true;
                                autoPickButton.classList.add("btn-secondary"); // Optional: Update styling
                                autoPickButton.classList.remove("btn-outline-secondary");

                                resetButton.disabled = true;
                                resetButton.classList.add("btn-secondary"); // Optional: Update styling
                                resetButton.classList.remove("btn-outline-secondary");
                            }
                        })
                        .catch((error) => {
                            console.error("Error loading saved team:", error);
                        });

                })
                .catch((error) => {
                    console.error("Error fetching team status:", error);
                });

            // Save Team Button Event Listener
            saveTeamButton.addEventListener("click", function () {
                // const pitchPositions = document.querySelectorAll(".position-absolute .player-card-save");
                const pitchPositions = document.querySelectorAll(".player-card-save");
                const teamData = [];
                const teamName = document.getElementById("teamName").textContent.trim();
                const teamId = document.getElementById("teamId").textContent.trim();
                const current_gameweek= document.getElementById("current_gameweek").textContent.trim();

                pitchPositions.forEach((playerCard) => {
                    if (playerCard) {
                        const positionContainer = playerCard.parentElement; // Get parent container (position-absolute)
                        const positionCoordinates = {
                            top: positionContainer.style.top,
                            left: positionContainer.style.left,
                        };

                        const playerData = {
                            playerid: playerCard.getAttribute("data-playerid"),
                            name: playerCard.getAttribute("data-name"),
                            position: playerCard.getAttribute("data-position"),
                            team: playerCard.getAttribute("data-team") || "Unknown",
                            kickoff: playerCard.getAttribute("data-fixture-time") || "Unknown",
                            formation_name: document.getElementById("formation-select").value,
                            score: parseInt(playerCard.getAttribute("data-score") || "0"),
                            position_coordinates: JSON.stringify(positionCoordinates), // Add coordinates as JSON string
                            image_url: playerCard.getAttribute("data-team_shirt") || "", // Ensure image URL is passed
                        };
                        teamData.push(playerData);

                        // console.log(playerData);
                    }
                });


                if (teamData.length === 0) {
                    showToast("No players selected to save.", "danger");
                    return;
                }

                if (teamData.length !== 15) {
                    showToast("Team must have 15 Players.", "danger");
                    return;
                }

                // Send the team data to the backend
                fetch("/api/save-team/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: JSON.stringify({ team_name: teamName,team_id: teamId, current_gameweek: current_gameweek, team: teamData }), // Ensure payload matches backend expectation
                })
                    .then((response) => {
                        // console.log("Response status:", response.status); // Debug log
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error("Failed to save team.");
                    })
                    .then((data) => {
                        // Show success toast and disable button
                        showToast(data.message || "Team saved successfully!", "success");
                        saveTeamButton.disabled = true;
                        saveTeamButton.textContent = "Team Saved";
                        saveTeamButton.classList.add("btn-secondary");
                        saveTeamButton.classList.remove("btn-primary");

                        // Disable the Auto Pick and Reset buttons
                        autoPickButton.disabled = true;
                        autoPickButton.classList.add("btn-secondary"); // Optional: Update styling
                        autoPickButton.classList.remove("btn-outline-secondary");

                        resetButton.disabled = true;
                        resetButton.classList.add("btn-secondary"); // Optional: Update styling
                        resetButton.classList.remove("btn-outline-secondary");

                        // Show the modal
                        const leagueOptionsModal = new bootstrap.Modal(document.getElementById("leagueOptionsModal"));
                        leagueOptionsModal.show();

                        // Redirect to a new page after success
                        // window.location.href = "/api/manageteam/"; 
                    })
                    .catch((error) => {
                        console.error(error);
                        showToast("Error saving team. Please try again.", "danger");
                    });
            });

            const dismissButton = document.getElementById("dismissButton");

            dismissButton.addEventListener("click", function () {
                // Redirect to /api/manageteam/
                window.location.href = "/api/manageteam/";
            });


            // Helper function to get CSRF token
            function getCSRFToken() {
                const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
                return csrfTokenElement ? csrfTokenElement.value : "";
            }

            // Helper function to show toast messages
            function showToast(message, type) {
                const toastContainer = document.getElementById("toastContainer");
                if (!toastContainer) {
                    console.error("Toast container not found.");
                    return;
                }

                const toast = document.createElement("div");
                toast.className = `toast align-items-center text-white bg-${type} border-0`;
                toast.role = "alert";
                toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
                toastContainer.appendChild(toast);

                const bootstrapToast = new bootstrap.Toast(toast);
                bootstrapToast.show();

                toast.addEventListener("hidden.bs.toast", () => {
                    toastContainer.removeChild(toast);
                });
            }

        });
    </script>

    <!-- Get the saved players -->
    <script> 
            // let saved_player_repo;
            document.addEventListener("DOMContentLoaded", function () {
                fetchSavedPlayers();
            });
        
            function fetchSavedPlayers() {

                function getUserIdFromUrl() {
                    const urlParts = window.location.pathname.split('/');
                    const potentialUserId = urlParts[urlParts.length - 2]; // Get second-to-last part of URL

                    // Check if the URL contains 'team_selection' and if the ID is numeric
                    if (window.location.pathname.includes("team_selection") && /^\d+$/.test(potentialUserId)) {
                        return potentialUserId;  // Return the user ID if conditions are met
                    }
                    
                    return null;  // Return null if 'team_selection' is not in the URL or the ID is invalid
                }

                const userId = getUserIdFromUrl(); // Fetch the user_id from the URL (if any)

        
                // Construct URL based on user_id
                let url = "/api/get-saved-team/";
                if (userId) {
                    url = `/api/get-saved-team/${userId}/`; // Use the user-specific endpoint if user_id is present
                }
        
                fetch(url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                .then((response) => {
                    if (response.ok) return response.json();
                    throw new Error("Failed to fetch saved team.");
                })
                .then((data) => {

                    const current_gameweek= document.getElementById("current_gameweek").textContent.trim();

                    // Filter the players where gameweek is 27
                    const playersInGameweek = data.team.filter(player => player.gameweek === parseInt(current_gameweek,0));

                    // Check if there are any players for the specific gameweek
                    if (playersInGameweek.length > 0) {
                        const hidesubscontainer = document.getElementById("subs-container");
                        hidesubscontainer.style.display = "block";
                        renderSavedPlayers(playersInGameweek);  // Render only players with gameweek 27
                    }
                })
                .catch((error) => {
                    console.error("Error loading saved team:", error);
                });
            }

            // Convert kickoff time string into a Date object safely
            function parseKickoffTime(kickoffTime) {
                return kickoffTime !== "TBD" ? new Date(kickoffTime) : null;
            }

            // Find the earliest kickoff time
            function getEarliestKickoff(times) {
                const now = new Date();

                // Convert valid times to Date objects and filter out "TBD"
                let validTimes = times
                    .map(time => parseKickoffTime(time))
                    .filter(time => time !== null)  // Remove invalid times
                    .sort((a, b) => a - b);  // Sort by earliest first

                return validTimes.length > 0 ? validTimes[0] : null;  // Return the earliest, or null if none
            }

        
            function renderSavedPlayers(savedTeam) {
                const pitchFormation = document.getElementById("pitch-formation");
                const budgetDisplay = document.getElementById("budgetDisplay");
                const totalBudget = 100.0; // Initial budget
                const subsContainerInner = document.querySelector("#subs-container > div");
    
                pitchFormation.innerHTML = ""; // Clear the pitch
                subsContainerInner.innerHTML = ""; // Clear the sub slots
    
                let totalPlayerPrice = 0;

                // ✅ Check if any player's match has started
                let isAnyKickoffStarted = savedTeam.some(player => {
                    const kickoffTimes = Array.isArray(player.kickoff) ? player.kickoff : [player.kickoff];
                    const earliestKickoff = getEarliestKickoff(kickoffTimes);
                    return earliestKickoff && earliestKickoff < new Date();
                });

                // console.log("⚽ Any Match Started?:", isAnyKickoffStarted);
    
                savedTeam.forEach((player, index) => {
    
    
                    const positionMapping = {
                        "Goalkeepers": "GKP",
                        "Defenders": "DEF",
                        "Midfielders": "MID",
                        "Forwards": "FWD"
                    };
    
                    // Parse position coordinates
                    const coordinates = JSON.parse(player.position_coordinates || "{}");

                    // Extracting the kickoff time(s) from the player fixture data
                    const kickoffTimes = Array.isArray(player.kickoff) ? player.kickoff : [player.kickoff];
                        // const earliestKickoff = getEarliestKickoff(kickoffTimes);
                        // const testKickoffTimes = [
                        //     "2025-02-27T15:00:00Z",
                        //     "2025-02-24T19:30:00Z",  // The earliest one
                        //     "2025-03-01T12:00:00Z"
                        // ];

                        const earliestKickoff = getEarliestKickoff(kickoffTimes);
                        // const earliestKickoff = getEarliestKickoff(testKickoffTimes);

                        // console.log("Earliest Kickoff:", earliestKickoff);

                        // Determine whether to show price or score
                    // const displayValue = isAnyKickoffStarted ? `${player.score} pts` : `£${player.price}`;
                    const displayValue = isAnyKickoffStarted ? `£${player.price}` : `£${player.price}`;

    
    
                    // If the player's position is GKP, DEF, or MID (or coordinates are empty)
                    if (["GKP", "DEF", "FWD", "MID"].includes(player.position) || coordinates.top === "" || coordinates.left === "") {
                        // Create sub slot for this player
                        const slot = document.createElement("div");
                        slot.className = "sub-slot text-center";
                        slot.style.width = "120px";
                        slot.style.padding = "10px";
                        slot.style.border = "1px dashed #ccc";
                        slot.style.cursor = "pointer";
                        slot.style.position = "relative";
    
                        // Adjust the label and the placement
                        const label = positionMapping[player.position] || player.position; // Use the mapped label, fall back to full if not found
    
                        slot.innerHTML = `<div>${label}</div>`;
    
                        // Add the player card to the slot
    
                        slot.innerHTML += `
                            <div class="rounded text-center shadow-sm position-relative player-card-save" 
                                style="font-family: Arial, sans-serif; cursor: pointer;"  
                                data-name="${player.name}" 
                                data-playerid="${player.player_id}"
                                data-image="${player.team_shirt}" 
                                data-team_shirt="${player.team_shirt}"
                                data-position="${player.position}"  
                                data-price="${player.price}"
                                data-fixture="${player.fixture}"
                                data-form="${player.form || 'N/A'}"
                                data-tsb="${player.tsb || '0%'}"
                                data-team="${player.team}" 
                                data-captain="${player.is_captain}"
                                data-vicecaptain="${player.is_vicecaptain}"
                                data-teamlogo="${player.teamLogo}" 
                                data-fixture-team1="${player.fixture_data.team1}"
                                data-fixture-team1logo="${player.fixture_data.team1Logo}"
                                data-fixture-team2="${player.fixture_data.team2}"
                                data-fixture-team2logo="${player.fixture_data.team2Logo}"
                                data-fixture-time="${player.fixture_data.time}">
    
                                <!-- Image as Background -->
                                <div class="position-relative">
                                <div class="price-tag">
                                    <!-- Captain Badge (Conditionally Shown) -->
                                    ${Boolean(player.is_captain) ? `<img src="{% static 'images/caption.png' %}" alt="Captain" style="height: 20px; width: auto; display: block; position: absolute; top: 5px; left: 5px;" />` : ''}
                                    <!-- Vice-Captain Badge (Conditionally Shown) -->
                                    ${Boolean(player.is_vicecaptain) ? `<img src="{% static 'images/vcaption.png' %}" alt="VCaptain" style="height: 20px; width: auto; display: block; position: absolute; top: 5px; right: 5px;" />` : ''}
                                   
                                    ${displayValue}

                                </div>
                                    <img src="${player.image}" 
                                        alt="${player.name.split(' ')[0]}" 
                                        onerror="this.onerror=null; this.src='{% static 'images/default2.png' %}'; this.parentElement.parentElement.setAttribute('data-image', this.src);" 
                                        class="player-image">
                                    
                                    <!-- First Overlayed Text (Positioned at Bottom) -->
                                    <div class="bg-white position-absolute w-100 text-center" 
                                        style="bottom: 18px; left: 0; font-size: 0.6rem; font-weight: bold; color: #4A4A4A; padding: 3px; z-index: 2; background: rgba(255, 255, 255, 0.8);">
                                        ${player.name.split(" ")[0]}
                                    </div>
    
                                    <!-- Second Overlayed Text (Directly Below the First) -->
                                    <div class="position-absolute w-100 text-center" 
                                        style="bottom: 0px; left: 0; font-size: 0.5rem; font-weight: bold; color: #000033; padding: 3px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; z-index: 3; background: rgb(184,184,184);">
                                        ${player.fixture}
                                    </div>
                                </div>
                            </div>
    
                        `;
    
                        // Attach event listener to show modal on click
                        slot.querySelector(".player-card-save").addEventListener("click", function () {
                            
                            showPlayerModal(

                                index,
    
                                this.getAttribute("data-captain"),
                                this.getAttribute("data-vicecaptain"),
    
                                this.getAttribute("data-name"), 
                                this.getAttribute("data-playerid"),
                                this.getAttribute("data-image"),
                                this.getAttribute("data-position"),
                                this.getAttribute("data-price") || "£0.0m",
                                this.getAttribute("data-form") || "N/A",
                                this.getAttribute("data-tsb") || "0%",
                                this.getAttribute("data-team") || "Unknown Team",
                                this.getAttribute("data-teamlogo"),
                                {
                                    team1: this.getAttribute("data-fixture-team1") || "Team A",
                                    team1Logo: this.getAttribute("data-fixture-team1logo"),
                                    team2: this.getAttribute("data-fixture-team2") || "Team B",
                                    team2Logo: this.getAttribute("data-fixture-team2logo"),
                                    time: this.getAttribute("data-fixture-time") || "TBD"
                                }
                            );
                        });
    
                        subsContainerInner.appendChild(slot); // Append to the subs section
                    } else {
    
                        const positionDiv = document.createElement("div");
                        positionDiv.className = "position-absolute text-center";
                        positionDiv.style.transform = "translate(-50%, -50%)";
                        positionDiv.setAttribute("data-index", index);
                        positionDiv.setAttribute("data-position", player.position);
    
                        // console.log(player.team_shirt);
                        // Otherwise, render in the pitch formation
                        positionDiv.style.top = coordinates.top;
                        positionDiv.style.left = coordinates.left;
                        positionDiv.innerHTML = `
                            <div class="rounded text-center shadow-sm position-relative player-card-save" 
                                style="font-family: Arial, sans-serif; cursor: pointer;"  
                                data-name="${player.name}" 
                                data-playerid="${player.player_id}"
                                data-image="${player.team_shirt}" 
                                data-team_shirt="${player.team_shirt}"
                                data-position="${player.position}"  
                                data-price="${player.price}"
                                data-fixture="${player.fixture}"
                                data-form="${player.form || 'N/A'}"
                                data-tsb="${player.tsb || '0%'}"
                                data-team="${player.team}" 
                                data-captain="${player.is_captain}"
                                data-vicecaptain="${player.is_vicecaptain}"
                                data-teamlogo="${player.teamLogo}" 
                                data-fixture-team1="${player.fixture_data.team1}"
                                data-fixture-team1logo="${player.fixture_data.team1Logo}"
                                data-fixture-team2="${player.fixture_data.team2}"
                                data-fixture-team2logo="${player.fixture_data.team2Logo}"
                                data-fixture-time="${player.fixture_data.time}">
    
                                <!-- Image as Background -->
                                <div class="position-relative">
                                <div class="price-tag">
                                    <!-- Captain Badge (Conditionally Shown) -->
                                    ${Boolean(player.is_captain) ? `<img src="{% static 'images/caption.png' %}" alt="Captain" style="height: 20px; width: auto; display: block; position: absolute; top: 5px; left: 5px;" />` : ''}
                                    <!-- Vice-Captain Badge (Conditionally Shown) -->
                                    ${Boolean(player.is_vicecaptain) ? `<img src="{% static 'images/vcaption.png' %}" alt="VCaptain" style="height: 20px; width: auto; display: block; position: absolute; top: 5px; right: 5px;" />` : ''}
                                    ${displayValue}
                                </div>
                                    <img src="${player.team_shirt}" 
                                        alt="${player.name.split(' ')[0]}" 
                                        onerror="this.onerror=null; this.src='{% static 'images/default1.png' %}'; this.parentElement.parentElement.setAttribute('data-image', this.src);" 
                                        class="player-image">
                                    
                                    <!-- First Overlayed Text (Positioned at Bottom) -->
                                    <div class="bg-white position-absolute w-100 text-center" 
                                        style="bottom: 18px; left: 0; font-size: 0.6rem; font-weight: bold; color: #4A4A4A; padding: 3px; z-index: 2; background: rgba(255, 255, 255, 0.8);">
                                        ${player.name.split(" ")[0]}
                                    </div>
    
                                    <!-- Second Overlayed Text (Directly Below the First) -->
                                    <div class="position-absolute w-100 text-center" 
                                        style="bottom: 0px; left: 0; font-size: 0.5rem; font-weight: bold; color: #000033; padding: 3px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; z-index: 3; background: rgb(184,184,184);">
                                        ${player.fixture}
                                    </div>
                                </div>
                            </div>
    
                        `;
    
    
                        // Attach event listener to show modal on click
                        positionDiv.querySelector(".player-card-save").addEventListener("click", function () {
                            showPlayerModal(

                                index,
    
                                this.getAttribute("data-captain"),
                                this.getAttribute("data-vicecaptain"),
    
                                this.getAttribute("data-name"), 
                                this.getAttribute("data-playerid"),
                                this.getAttribute("data-image"),
                                this.getAttribute("data-position"),
                                this.getAttribute("data-price") || "£0.0m",
                                this.getAttribute("data-form") || "N/A",
                                this.getAttribute("data-tsb") || "0%",
                                this.getAttribute("data-team") || "Unknown Team",
                                this.getAttribute("data-teamlogo"),
                                {
                                    team1: this.getAttribute("data-fixture-team1") || "Team A",
                                    team1Logo: this.getAttribute("data-fixture-team1logo"),
                                    team2: this.getAttribute("data-fixture-team2") || "Team B",
                                    team2Logo: this.getAttribute("data-fixture-team2logo"),
                                    time: this.getAttribute("data-fixture-time") || "TBD"
                                }
                            );
                        });
    
                        pitchFormation.appendChild(positionDiv); // Append to the pitch formation
                    }
    
                    totalPlayerPrice += parseFloat(player.price) || 0;
                });
    
                // Update budget
                const remainingBudget = totalBudget - totalPlayerPrice;
                budgetDisplay.textContent = `£${remainingBudget.toFixed(1)}m`;
            }
    
            // Function to show modal with player details
            function showPlayerModal(show,is_captain,is_vicecaptain,name, playerId, image, position, price, form, tsb, team, teamLogo, fixture) {
                const modal = document.getElementById("playerModal");
                const captainBadge = document.getElementById("captainBadge");
                const vicecaptainBadge = document.getElementById("vicecaptainBadge");
    
                const makeCaptainButton = document.getElementById("makeCaptainButton");
                const makeViceCaptainButton = document.getElementById("makeViceCaptainButton");
                const transferOutButton = document.getElementById("transferOutButton");

                if (show<11){
                    makeCaptainButton.style.display = "block";  // Hide Make Captain button
                    makeViceCaptainButton.style.display = "block";  // Hide Make Vice Captain button
                } else{
                    makeCaptainButton.style.display = "none";  // Hide Make Captain button
                    makeViceCaptainButton.style.display = "none";  // Hide Make Vice Captain button                    
                }

                // Get the current URL
                const currentUrl = window.location.href;

                // Check if the URL contains an ID (e.g., 'https://pangasquadii.digitlogic.co.ke/api/team_selection/1/')
                const hasIdInUrl = currentUrl.match(/\/\d+\/$/); // This checks if there is an ID at the end of the URL


                if (hasIdInUrl) {
                    // Disable the formation select if ID is present in the URL
                    makeCaptainButton.style.display = "none";  // Hide Make Captain button
                    makeViceCaptainButton.style.display = "none";  // Hide Make Vice Captain button 
                } 

                // Convert is_captain to boolean if it's a string
                const isCaptainBoolean = (is_captain === true || is_captain === "true" || is_captain === 1);
    
                // Convert is_captain to boolean if it's a string
                const isVcaptainBoolean = (is_vicecaptain === true || is_vicecaptain === "true" || is_vicecaptain === 1);
    
                // Initially hide the captain badge when the modal opens
                captainBadge.style.display = "none";  // Hide by default
    
                // Initially hide the captain badge when the modal opens
                vicecaptainBadge.style.display = "none";  // Hide by default
                transferOutButton.style.display = "none";  // Hide by default
                switchOutButton.style.display = "none";
    
                // Show the captain badge only if the player is the captain
                if (isCaptainBoolean) {
                    captainBadge.style.display = "block";  // Show the badge if the player is the captain
                    makeViceCaptainButton.disabled = true;
                }else{
                    captainBadge.style.display = "none";  // Hide Captain Badge
                    makeViceCaptainButton.disabled = false;  // Enable Make Captain button
                }
    
                // Show the captain badge only if the player is the captain
                if (isVcaptainBoolean) {
                    vicecaptainBadge.style.display = "block";  // Show the badge if the player is the captain
                    makeCaptainButton.disabled = true;
                }else{
                    vicecaptainBadge.style.display = "none";  // Hide Vice-Captain Badge
                    makeCaptainButton.disabled = false;  // Enable Make Vice-Captain button
                }
                
                // Check if modal exists
                if (!modal) {
                    console.error("Modal element not found!");
                    return;
                }
    
                // Set player details
                document.getElementById("modalPlayerName").textContent = name;
                document.getElementById("modalPlayerImage").src = image;
                document.getElementById("modalPlayerImage").onerror = function () {
                    this.onerror = null;
                    this.src = "https://via.placeholder.com/80"; // Fallback image
                };
                document.getElementById("modalPlayerPosition").textContent = position;
                document.getElementById("modalPlayerPrice").textContent = "£" + price + "m";
                document.getElementById("modalPlayerForm").textContent = form;
                document.getElementById("modalPlayerTSB").textContent = tsb;
                document.getElementById("modalTeamName").textContent = team;
                document.getElementById("modalTeamLogo").src = teamLogo;
                document.getElementById("modalPlayerImage").setAttribute("data-playerid", playerId);
                document.getElementById("modalTeamLogo").onerror = function () {
                    this.onerror = null;
                    this.src = "{% static 'images/default3.png' %}"; // Fallback team logo
                };
    
                // **Convert fixture?.time to a formatted date**
                let fixtureDate = "TBD"; // Default if no date is provided
                if (fixture && fixture?.time && fixture?.time !== "TBD") {
                    try {
                        let dateObj = new Date(fixture?.time);
                        let options = { weekday: "long", day: "numeric", month: "long" };
                        fixtureDate = dateObj.toLocaleDateString("en-GB", options); // Example: "Saturday 15 February"
                    } catch (error) {
                        console.error("Error parsing fixture time:", error);
                    }
                }
    
                // Set fixture details
                document.getElementById("fixtureTeam1Name").textContent = fixture?.team1 || "Team A";
                document.getElementById("fixtureTeam1Logo").src = fixture?.team1Logo;
                document.getElementById("fixtureTeam1Logo").onerror = function () {
                    this.onerror = null;
                    this.src = "{% static 'images/default3.png' %}"; // Fallback team1 logo
                };
    
                document.getElementById("fixtureTeam2Name").textContent = fixture?.team2 || "Team B";
                document.getElementById("fixtureTeam2Logo").src = fixture?.team2Logo;
                document.getElementById("fixtureTeam2Logo").onerror = function () {
                    this.onerror = null;
                    this.src = "{% static 'images/default3.png' %}"; // Fallback team2 logo
                };
    
                    // Hide team2Logo if the team name is "Unknown"
                if (fixture?.team2 === "Unknown" || fixture?.team2 === "None") {
                    document.getElementById("fixtureTeam2Logo").style.display = "none";  // Hide logo
                } else {
                    document.getElementById("fixtureTeam2Logo").style.display = "inline"; // Show logo
                }
                
                document.getElementById("fixtureTime").textContent = fixtureDate; // Now dynamically formatted
                document.getElementById("fixtureDate").textContent = fixtureDate;
    
                // Show modal
                modal.style.display = "block";
            }
    
    
        
            // Close the modal
            document.getElementById("closeModalButton").addEventListener("click", function () {
                document.getElementById("playerModal").style.display = "none";
            });
        
            // Close modal when clicking outside of it
            document.getElementById("playerModal").addEventListener("click", function (e) {
                if (e.target === this) {
                    this.style.display = "none";
                }
            });
        
            // If using HTMX, listen for page updates
            document.body.addEventListener("htmx:afterSwap", function () {
                fetchSavedPlayers();
            });
        
    </script>

    <!-- Shuffle Player Selections -->
    <script>
        // let teamPresent = false;
        document.addEventListener("DOMContentLoaded", function () {
            // Define formations and their respective positions
            const formations = {
                    
                    "4-4-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "35%" },
                        { position: "Midfielders", top: "55%", left: "65%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "4-3-3": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "15%" },
                        { position: "Forwards", top: "75%", left: "50%" },
                        { position: "Forwards", top: "75%", left: "85%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "3-4-3": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "20%" },
                        { position: "Defenders", top: "35%", left: "80%" },
                        { position: "Defenders", top: "35%", left: "50%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "38%" },
                        { position: "Midfielders", top: "55%", left: "63%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "20%" },
                        { position: "Forwards", top: "75%", left: "50%" },
                        { position: "Forwards", top: "75%", left: "80%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ], 

                    "3-5-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "20%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "80%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "30%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "70%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ], 

                    "4-5-1": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "35%" },
                        { position: "Defenders", top: "35%", left: "65%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "10%" },
                        { position: "Midfielders", top: "55%", left: "30%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "70%" },
                        { position: "Midfielders", top: "55%", left: "90%" },

                        { position: "Forwards", top: "75%", left: "50%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],                    
                    
                    "5-3-2": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "30%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "70%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "50%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "25%" },
                        { position: "Forwards", top: "75%", left: "75%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ],

                    "5-4-1": [
                        { position: "Goalkeepers", top: "14%", left: "50%" },

                        { position: "Defenders", top: "35%", left: "10%" },
                        { position: "Defenders", top: "35%", left: "30%" },
                        { position: "Defenders", top: "35%", left: "50%" },
                        { position: "Defenders", top: "35%", left: "70%" },
                        { position: "Defenders", top: "35%", left: "90%" },

                        { position: "Midfielders", top: "55%", left: "15%" },
                        { position: "Midfielders", top: "55%", left: "38%" },
                        { position: "Midfielders", top: "55%", left: "63%" },
                        { position: "Midfielders", top: "55%", left: "85%" },

                        { position: "Forwards", top: "75%", left: "50%" },

                        { position: "Goalkeepers", top: "100%", left: "29%" },
                        { position: "Defenders", top: "100%", left: "43%" },
                        { position: "Midfielders", top: "100%", left: "57%" },
                        { position: "Forwards", top: "100%", left: "71%" }
                    ]

                };
            
            const formationSelect = document.getElementById("formation-select");
            const pitchFormation = document.getElementById("pitch-formation");
            const autoPickButton = document.getElementById("autoPickButton");
            const budgetDisplay = document.getElementById("budgetDisplay");
            const favoriteClubId = "{{ favorite_club_id }}"; // Pass from backend

            let totalBudget = 100.0; // Total available budget
            let remainingBudget = totalBudget; // Remaining budget
            let players = []; // Players will be dynamically populated

            // Fetch players dynamically based on teamId
            async function fetchPlayersByTeam(teamId) {
                try {
                    const response = await fetch(`/api/get-saved-team/`);
                    const data = await response.json();
                    // console.log("Players fetched from API:", data.team);
                    if (data && data.team) {
                        // players = data.team.map((player) => ({
                        players = data.team
                            .filter(player => {
                                const coordinates = JSON.parse(player.position_coordinates || "{}");
                                return !(
                                    ["GKP", "DEF", "FWD", "MID"].includes(player.position) || 
                                    coordinates.top === "" || 
                                    coordinates.left === ""
                                );
                            })    
                            .filter(player => {
                                // Filter by gameweek
                                const current_gameweek= document.getElementById("current_gameweek").textContent.trim();
                                return player.gameweek === parseInt(current_gameweek,0);  // Ensure prev_gameweek is an integer
                            })
                            .map(player => ({
                                id: player.player_id,
                                name: player.name,
                                position: player.position,
                                price: player.price,
                                form: player.form || "N/A",
                                total_points: player.total_points,
                                tsb: player.tsb || "0%",
                                fixture: player.fixture,
                                team: player.team,
                                is_captain: player.is_captain,
                                is_vicecaptain: player.is_vicecaptain,
                                team_short: player.team_short,
                                teamLogo: player.teamLogo,
                                image: player.image || "https://resources.premierleague.com/premierleague/photos/players/110x140/p204716.png", // Fallback image
                                team_shirt: player.team_shirt || "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_8-110.webp", // Fallback shirt
                                // Fixture Details
                                fixture_data: {
                                    team1: player.fixture_data?.team1 || "Unknown",
                                    team1Logo: player.fixture_data?.team1Logo,
                                    team2: player.fixture_data?.team2 || "Unknown",
                                    team2Logo: player.fixture_data?.team2Logo,
                                    time: player.fixture_data?.time || "TBD"
                                },

                            }));
                        // console.log(players);
                        // window.sub_players = players;
                    } else {
                        console.error("No players found for the selected team.");
                    }
                } catch (error) {
                    console.error("Error fetching players:", error);
                }
            }

            // Update the budget display
            function updateBudgetDisplay() {
                budgetDisplay.textContent = `£${remainingBudget.toFixed(1)}m`;
            }

                        // Highlight selected pitch position
            const highlightPosition = (positionDiv, color = 'green') => {

            selectedPositionReplace = null;
            document.querySelectorAll(".pitch-position").forEach((div) => {
                div.style.border = ""; // Reset border for all positions
            });
            if (positionDiv) {
                positionDiv.style.border = `2px dashed ${color}`; // Highlight selected position
                selectedPositionElement = positionDiv;
            }
            };

            function autoPickPlayers(formationKey) {
                const formation = formations[formationKey];
                if (!formation) {
                    console.error("Formation not found:", formationKey);
                    return;
                }

                // Group players by position
                const groupedPlayers = {};
                players.forEach((player) => {
                    if (!groupedPlayers[player.position]) {
                        groupedPlayers[player.position] = [];
                    }
                    groupedPlayers[player.position].push(player);
                });

                // Shuffle players in each position group to ensure randomness
                Object.keys(groupedPlayers).forEach((position) => {
                    groupedPlayers[position] = groupedPlayers[position].sort(() => 0.5 - Math.random());
                });

                remainingBudget = totalBudget; // Reset budget
                updateBudgetDisplay();
                pitchFormation.innerHTML = ""; // Clear the pitch

                const usedPlayers = new Set();
                const teamPlayerCount = {}; // Track team limits

                // Keep track of available backup players in case a position is missing
                let backupPlayers = [...players].sort(() => 0.5 - Math.random()); // Fallback players list

                formation.forEach((slot) => {
                    let selectedPlayer = null;

                    // Try to get a player from the correct position
                    if (groupedPlayers[slot.position] && groupedPlayers[slot.position].length > 0) {
                        for (let i = 0; i < groupedPlayers[slot.position].length; i++) {
                            const potentialPlayer = groupedPlayers[slot.position][i];

                            if (usedPlayers.has(potentialPlayer.name)) continue;
                            if (teamPlayerCount[potentialPlayer.team] && teamPlayerCount[potentialPlayer.team] >= 3) continue;
                            if (potentialPlayer.price > remainingBudget) continue;

                            selectedPlayer = potentialPlayer;
                            groupedPlayers[slot.position].splice(i, 1); // Remove from available list
                            break;
                        }
                    }

                    // If no suitable player is found, use a backup player from another position
                    if (!selectedPlayer) {
                        for (let i = 0; i < backupPlayers.length; i++) {
                            const potentialBackup = backupPlayers[i];

                            if (usedPlayers.has(potentialBackup.name)) continue;
                            if (teamPlayerCount[potentialBackup.team] && teamPlayerCount[potentialBackup.team] >= 3) continue;
                            if (potentialBackup.price > remainingBudget) continue;

                            selectedPlayer = potentialBackup;
                            backupPlayers.splice(i, 1); // Remove from available backups
                            // console.warn(`Used backup player for position: ${slot.position}`);
                            break;
                        }
                    }

                    if (!selectedPlayer) {
                        console.warn("No affordable player for position:", slot.position);
                        return;
                    }

                    // Mark player as used
                    usedPlayers.add(selectedPlayer.name);
                    remainingBudget -= selectedPlayer.price;
                    teamPlayerCount[selectedPlayer.team] = (teamPlayerCount[selectedPlayer.team] || 0) + 1;

                    // Create player card
                    const playerDiv = document.createElement("div");
                    playerDiv.className = "position-absolute text-center";
                    playerDiv.style.top = slot.top;
                    playerDiv.style.left = slot.left;
                    playerDiv.style.transform = "translate(-50%, -50%)";

                    // Default images categorized by position
                    const defaultImagesByPosition = {
                        "Goalkeepers": [
                            "https://resources.premierleague.com/premierleague/photos/players/110x140/p463748.png",
                            "https://resources.premierleague.com/premierleague/photos/players/110x140/p462492.png",
                            "https://resources.premierleague.com/premierleague/photos/players/110x140/p248164.png"
                        ],
                        "Defenders": [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_31-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_14-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_91-110.webp"
                        ],
                        "Midfielders": [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_31-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_14-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_91-110.webp"
                        ],
                        "Forwards": [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_31-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_14-110.webp",
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_91-110.webp"
                        ]
                    };

                    // Function to get a random default image based on player position
                    function getRandomDefaultImage(position) {
                        const images = defaultImagesByPosition[position] || [
                            "https://fplchallenge.premierleague.com/dist/img/shirts/standard/shirt_11-66.webp"
                        ];
                        return images[Math.floor(Math.random() * images.length)];
                    }

                    // Determine final image
                    const finalImage = selectedPlayer.team_shirt || getRandomDefaultImage(selectedPlayer.position);

                    playerDiv.innerHTML = `
                        <div class="rounded text-center shadow-sm position-relative player-card-save" 
                            style="font-family: Arial, sans-serif; cursor: pointer;"  
                            data-name="${selectedPlayer.name}" 
                            data-playerid="${selectedPlayer.id}"
                            data-image="${selectedPlayer.team_shirt}" 
                            data-position="${selectedPlayer.position}"
                            data-price="${selectedPlayer.price}" 
                            data-team_shirt="${selectedPlayer.team_shirt}"
                            data-form="${selectedPlayer.form || 'N/A'}"
                            data-tsb="${selectedPlayer.tsb || '0%'}"
                            data-team="${selectedPlayer.team}" 
                            data-captain="${selectedPlayer.is_captain}"
                            data-vicecaptain="${selectedPlayer.is_vicecaptain}"
                            data-teamlogo="${selectedPlayer.teamLogo}" 
                            data-fixture-team1="${selectedPlayer.fixture_data.team1}"
                            data-fixture-team1logo="${selectedPlayer.fixture_data.team1Logo}"
                            data-fixture-team2="${selectedPlayer.fixture_data.team2}"
                            data-fixture-team2logo="${selectedPlayer.fixture_data.team2Logo}"
                            data-fixture-time="${selectedPlayer.fixture_data.time}">

                            <div class="position-relative">
                                <div class="price-tag">
                                    <!-- Captain Badge (Conditionally Shown) -->
                                    ${Boolean(selectedPlayer.is_captain) ? `<img src="{% static 'images/caption.png' %}" alt="Captain" style="height: 20px; width: auto; display: block; position: absolute; top: 5px; left: 5px;" />` : ''}
                                    <!-- Vice-Captain Badge (Conditionally Shown) -->
                                    ${Boolean(selectedPlayer.is_vicecaptain) ? `<img src="{% static 'images/vcaption.png' %}" alt="VCaptain" style="height: 20px; width: auto; display: block; position: absolute; top: 5px; right: 5px;" />` : ''}
                                    £${selectedPlayer.price}
                                </div>
                                <img src="${finalImage}" 
                                    alt="${selectedPlayer.name.split(" ")[0]}" 
                                    onerror="this.onerror=null; this.src='${getRandomDefaultImage(selectedPlayer.position)}'; this.parentElement.parentElement.setAttribute('data-image', this.src);" 
                                    class="player-image">
                                
                                <div class="bg-white position-absolute w-100 text-center" 
                                    style="bottom: 18px; left: 0; font-size: 0.6rem; font-weight: bold; color: #4A4A4A; padding: 3px; z-index: 2; background: rgba(255, 255, 255, 0.8);">
                                    ${selectedPlayer.name.split(" ")[0]}
                                </div>

                                <div class="position-absolute w-100 text-center" 
                                    style="bottom: 0px; left: 0; font-size: 0.5rem; font-weight: bold; color: #000033; padding: 3px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; z-index: 3; background: rgb(184,184,184);">
                                    ${selectedPlayer.fixture}
                                </div>
                            </div>
                        </div>
                    `;

                    // Add click event to open modal
                    playerDiv.querySelector(".player-card-save").addEventListener("click", function () {
                        showPlayerModal( 

                            this.getAttribute("data-captain"),
                            this.getAttribute("data-vicecaptain"),
    
                            this.getAttribute("data-name"), 
                            this.getAttribute("data-playerid"),
                            this.getAttribute("data-image"),
                            this.getAttribute("data-position"),
                            this.getAttribute("data-price") || "£0.0m",
                            this.getAttribute("data-form") || "N/A",
                            this.getAttribute("data-tsb") || "0%",
                            this.getAttribute("data-team") || "Unknown Team",
                            this.getAttribute("data-teamlogo"),
                            {
                                team1: this.getAttribute("data-fixture-team1") || "Team A",
                                team1Logo: this.getAttribute("data-fixture-team1logo"),
                                team2: this.getAttribute("data-fixture-team2") || "Team B",
                                team2Logo: this.getAttribute("data-fixture-team2logo"),
                                time: this.getAttribute("data-fixture-time") || "TBD"
                            }
                        );
                    });

                    pitchFormation.appendChild(playerDiv);
                    updateBudgetDisplay();
                });
            }

                        // Function to show modal with player details
            function showPlayerModal(is_captain,is_vicecaptain,name, playerId, image, position, price, form, tsb, team, teamLogo, fixture) {
                const modal = document.getElementById("playerModal");
                const captainBadge = document.getElementById("captainBadge");
                const vicecaptainBadge = document.getElementById("vicecaptainBadge");
    
                const makeCaptainButton = document.getElementById("makeCaptainButton");
                const makeViceCaptainButton = document.getElementById("makeViceCaptainButton");
                const transferOutButton = document.getElementById("transferOutButton");
    
                makeCaptainButton.style.display = "block";  // Hide Make Captain button
                makeViceCaptainButton.style.display = "block";  // Hide Make Vice Captain button
    
                // Convert is_captain to boolean if it's a string
                const isCaptainBoolean = (is_captain === true || is_captain === "true" || is_captain === 1);
    
                // Convert is_captain to boolean if it's a string
                const isVcaptainBoolean = (is_vicecaptain === true || is_vicecaptain === "true" || is_vicecaptain === 1);
    
                // Initially hide the captain badge when the modal opens
                captainBadge.style.display = "none";  // Hide by default
    
                // Initially hide the captain badge when the modal opens
                vicecaptainBadge.style.display = "none";  // Hide by default
                transferOutButton.style.display = "none";  // Hide by default
                switchOutButton.style.display = "none";
    
                // Show the captain badge only if the player is the captain
                if (isCaptainBoolean) {
                    captainBadge.style.display = "block";  // Show the badge if the player is the captain
                    makeViceCaptainButton.disabled = true;
                }else{
                    captainBadge.style.display = "none";  // Hide Captain Badge
                    makeViceCaptainButton.disabled = false;  // Enable Make Captain button
                }
    
                // Show the captain badge only if the player is the captain
                if (isVcaptainBoolean) {
                    vicecaptainBadge.style.display = "block";  // Show the badge if the player is the captain
                    makeCaptainButton.disabled = true;
                }else{
                    vicecaptainBadge.style.display = "none";  // Hide Vice-Captain Badge
                    makeCaptainButton.disabled = false;  // Enable Make Vice-Captain button
                }
                
                // Check if modal exists
                if (!modal) {
                    console.error("Modal element not found!");
                    return;
                }
    
                // Set player details
                document.getElementById("modalPlayerName").textContent = name;
                document.getElementById("modalPlayerImage").src = image;
                document.getElementById("modalPlayerImage").onerror = function () {
                    this.onerror = null;
                    this.src = "https://via.placeholder.com/80"; // Fallback image
                };
                document.getElementById("modalPlayerPosition").textContent = position;
                document.getElementById("modalPlayerPrice").textContent = "£" + price + "m";
                document.getElementById("modalPlayerForm").textContent = form;
                document.getElementById("modalPlayerTSB").textContent = tsb;
                document.getElementById("modalTeamName").textContent = team;
                document.getElementById("modalTeamLogo").src = teamLogo;
                document.getElementById("modalPlayerImage").setAttribute("data-playerid", playerId);
                document.getElementById("modalTeamLogo").onerror = function () {
                    this.onerror = null;
                    this.src = "{% static 'images/default3.png' %}"; // Fallback team logo
                };
    
                // **Convert fixture?.time to a formatted date**
                let fixtureDate = "TBD"; // Default if no date is provided
                if (fixture && fixture?.time && fixture?.time !== "TBD") {
                    try {
                        let dateObj = new Date(fixture?.time);
                        let options = { weekday: "long", day: "numeric", month: "long" };
                        fixtureDate = dateObj.toLocaleDateString("en-GB", options); // Example: "Saturday 15 February"
                    } catch (error) {
                        console.error("Error parsing fixture time:", error);
                    }
                }
    
                // Set fixture details
                document.getElementById("fixtureTeam1Name").textContent = fixture?.team1 || "Team A";
                document.getElementById("fixtureTeam1Logo").src = fixture?.team1Logo;
                document.getElementById("fixtureTeam1Logo").onerror = function () {
                    this.onerror = null;
                    this.src = "{% static 'images/default3.png' %}"; // Fallback team1 logo
                };
    
                document.getElementById("fixtureTeam2Name").textContent = fixture?.team2 || "Team B";
                document.getElementById("fixtureTeam2Logo").src = fixture?.team2Logo;
                document.getElementById("fixtureTeam2Logo").onerror = function () {
                    this.onerror = null;
                    this.src = "{% static 'images/default3.png' %}"; // Fallback team2 logo
                };
    
                    // Hide team2Logo if the team name is "Unknown"
                if (fixture?.team2 === "Unknown" || fixture?.team2 === "None") {
                    document.getElementById("fixtureTeam2Logo").style.display = "none";  // Hide logo
                } else {
                    document.getElementById("fixtureTeam2Logo").style.display = "inline"; // Show logo
                }
                
                document.getElementById("fixtureTime").textContent = fixtureDate; // Now dynamically formatted
                document.getElementById("fixtureDate").textContent = fixtureDate;
    
                // Show modal
                modal.style.display = "block";
            }
    
    
            document.getElementById("closeModalButton").addEventListener("click", function () {
                document.getElementById("playerModal").style.display = "none";
            });

            document.getElementById("playerModal").addEventListener("click", function (e) {
                if (e.target === this) {
                    this.style.display = "none";
                }
            });
            
            formationSelect.addEventListener("change", function () {
                if(teamPresent === true){
                saveTeamButton.disabled = false;
                saveTeamButton.textContent = "Update Team";
                saveTeamButton.classList.remove("btn-secondary");
                saveTeamButton.classList.add("btn-primary");
                // renderFormation(this.value);
                autoPickPlayers(formationSelect.value);}
            });

            // Execute renderFormation on load with the currently selected value or a default
            // renderFormation("4-3-3");

            // autoPickButton.addEventListener("click", function () {
            //     autoPickPlayers(formationSelect.value); // Trigger auto-pick based on the current formation
            // });

            async function initializeTeam(favoriteClubId) {
                try {
                    // Fetch players by team
                    await fetchPlayersByTeam(favoriteClubId);

                    // Fetch team status
                    const response = await fetch("/api/check-team-status/", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        throw new Error("Failed to fetch team status.");
                    }

                    const data = await response.json();

                    // if (!data.team_exists) {
                    //     renderFormation("4-4-2"); // Render the default formation
                    //     updateBudgetDisplay(); // Initialize budget display
                    //     // console.log('Sangulo');
                    // }else{
                        
                    // console.log(saved_player_repo);
                    // }

                        // renderFormation("4-4-2"); // Render the default formation
                        // updateBudgetDisplay(); // Initialize budget display

                } catch (error) {
                    console.error("Error initializing team:", error);
                }
            }

            // Usage
            fetchPlayersByTeam(favoriteClubId).then(() => {
                // initializeTeam(favoriteClubId);
            });

            
        });


    </script>
    
    <!-- fixtures-list pagenation -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const fixtureContainer = document.getElementById("fixtureContainer");
            const prevButton = document.getElementById("fixtures-prev-button");
            const nextButton = document.getElementById("fixtures-next-button");
            const currentPageSpan = document.getElementById("fixtures-current-page");
            const totalPagesSpan = document.getElementById("fixtures-total-pages");

            // Ensure TEAM_SHIRTS is available in JavaScript
            const TEAM_SHIRTS = {
                "Arsenal": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t3.png" },
                "Aston Villa": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t7.png" },
                "Bournemouth": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t91.png" },
                "Brentford": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t94.png" },
                "Brighton": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t36.png" },
                "Chelsea": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t8.png" },
                "Crystal Palace": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t31.png" },
                "Everton": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t11.png" },
                "Fulham": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t54.png" },
                "Ipswich": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t40.png" },
                "Leicester": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t13.png" },
                "Liverpool": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t14.png" },
                "Man City": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t43.png" },
                "Man Utd": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t1.png" },
                "Newcastle": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t4.png" },
                "Nott'm Forest": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t17.png" },
                "Southampton": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t20.png" },
                "Spurs": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t6.png" },
                "West Ham": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t21.png" },
                "Wolves": { "logo": "https://resources.premierleague.com/premierleague/badges/70/t39.png" }
            };

            // Function to update fixtures dynamically
            const updateFixtures = (page) => {
                fetch(`/api/teamselection/?page=${page}`, {
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        // console.log(data);
                        // Update fixtures content
                        let html = "";
                        for (const day of data.matches) {
                            html += `<h5 class="fw-bold text-dark mt-4">${day.date}</h5>`;
                            html += '<div class="timeline mt-3">';
                            for (const match of day.matches) {
                                // Get team names
                                const homeTeamName = match.home_team.name;
                                const awayTeamName = match.away_team.name;

                                // Get logos from TEAM_SHIRTS dictionary
                                const homeTeamLogo = TEAM_SHIRTS[homeTeamName]?.logo || "default_logo.png";
                                const awayTeamLogo = TEAM_SHIRTS[awayTeamName]?.logo || "default_logo.png";

                                html += `
                                <div class="d-flex align-items-center mb-3 bg-white rounded p-2 shadow-sm">
                                    <div class="me-2 text-center">
                                        <span class="fw-bold">${match.formatted_time}</span>
                                        <p class="text-muted small">${match.formatted_date}</p>
                                    </div>
                                    <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center me-3">
                                            <img src="${homeTeamLogo}" 
                                                alt="${match.home_team.name}" 
                                                class="img-fluid"
                                                style="height: 24px; width: 24px; margin-right: 8px;">
                                            <span>${match.home_team.name}</span>
                                        </div>
                                        <span class="fw-bold mx-3">vs</span>
                                        <div class="d-flex align-items-center ms-3">
                                            <span>${match.away_team.name}</span>
                                            <img src="${awayTeamLogo}" 
                                                alt="${match.away_team.name}" 
                                                class="img-fluid"
                                                style="height: 24px; width: 24px; margin-left: 8px;">
                                        </div>
                                    </div>
                                </div>`;
                            }
                            html += "</div>";
                        }
                        fixtureContainer.innerHTML = html;

                        // Update pagination
                        currentPageSpan.textContent = data.current_page;
                        totalPagesSpan.textContent = data.total_pages;
                        prevButton.disabled = !data.has_previous;
                        nextButton.disabled = !data.has_next;
                    })
                    .catch((error) => console.error("Error fetching fixtures:", error));
            };

            // Event listeners for pagination buttons
            prevButton.addEventListener("click", () => {
                const currentPage = parseInt(currentPageSpan.textContent);
                if (currentPage > 1) updateFixtures(currentPage - 1);
            });

            nextButton.addEventListener("click", () => {
                const currentPage = parseInt(currentPageSpan.textContent);
                const totalPages = parseInt(totalPagesSpan.textContent);
                if (currentPage < totalPages) updateFixtures(currentPage + 1);
            });

            // Initial fetch for the first page
            updateFixtures(1);
        });

    </script>

    <!-- Captain $ Vice Image -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const makeCaptainButton = document.getElementById("makeCaptainButton");
            const makeViceCaptainButton = document.getElementById("makeViceCaptainButton");

            if (!makeCaptainButton || !makeViceCaptainButton) {
                console.error("Captain or Vice Captain button not found.");
                return;
            }

            makeCaptainButton.addEventListener("click", function () {
                updateCaptainOrViceCaptain("captain");
            });

            makeViceCaptainButton.addEventListener("click", function () {
                updateCaptainOrViceCaptain("vice_captain");
            });

            function updateCaptainOrViceCaptain(role) {
                const playerId = document.getElementById("modalPlayerImage").getAttribute("data-playerid");

                if (!playerId) {
                    console.error("Player ID not found!");
                    return;
                }

                fetch("/api/update-captain/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({
                        role: role,
                        player_id: playerId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // console.log("Server Response:", data);
                    // alert(`${role.replace("_", " ")} updated successfully!`);

                    showToast(data.message || `${role.replace("_", " ")} updated successfully!`, "success");

                    // console.log(role);

                    
                    // Dynamically show the captain image if player is updated as captain
                    if (data.captain === playerId) {
                        document.getElementById("captainBadge").style.display = "block";  // Show the badge
                    }

                    if (role === 'captain') {
                        document.getElementById("captainBadge").style.display = "block";  // Show the badge
                    }

                    if (role === 'vice_captain') {
                        document.getElementById("vicecaptainBadge").style.display = "block";  // Show the badge
                    }

                    // Refresh the page to reflect the updated data
                    location.reload();  // Reloads the page
                })
                .catch(error => console.error("Error:", error));
            }

                        // Helper function to show toast messages
                        function showToast(message, type) {
                        const toastContainer = document.getElementById("toastContainer");
                        if (!toastContainer) {
                            console.error("Toast container not found.");
                            return;
                        }

                        const toast = document.createElement("div");
                        toast.className = `toast align-items-center text-white bg-${type} border-0`;
                        toast.role = "alert";
                        toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    `;
                        toastContainer.appendChild(toast);

                        const bootstrapToast = new bootstrap.Toast(toast);
                        bootstrapToast.show();

                        toast.addEventListener("hidden.bs.toast", () => {
                            toastContainer.removeChild(toast);
                        });
                    }

            function getCSRFToken() {
                let csrfToken = document.cookie
                    .split("; ")
                    .find(row => row.startsWith("csrftoken="))
                    ?.split("=")[1];

                return csrfToken || "";
            }
        });
    </script>

    <!-- Toggle Pitch -->
    <script>
        document.getElementById("hideDivLink").addEventListener("click", function() {
            var targetDiv = document.getElementById("targetDiv");
            var targetDiv1 = document.getElementById("targetDiv1");
            targetDiv.style.display = "none"; // Hides the div
            targetDiv1.style.display = "block"; // Show the div
        });

        document.getElementById("showDivLink").addEventListener("click", function() {
            var targetDiv = document.getElementById("targetDiv");
            var targetDiv1 = document.getElementById("targetDiv1");
            targetDiv.style.display = "block"; // Show the div
            targetDiv1.style.display = "none"; // Hides the div
        });
    </script>

    <!-- Disable formation selection -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Get the current URL
            const currentUrl = window.location.href;

            // Check if the URL contains an ID (e.g., 'https://pangasquadii.digitlogic.co.ke/api/team_selection/1/')
            const hasIdInUrl = currentUrl.match(/\/\d+\/$/); // This checks if there is an ID at the end of the URL

            // Get the formation select element
            const formationSelect = document.getElementById("formation-select");

            if (hasIdInUrl) {
                // Disable the formation select if ID is present in the URL
                formationSelect.disabled = true;
            } else {
                // Enable the formation select if no ID is found
                formationSelect.disabled = false;
            }
        });

    </script>

    <script>
        let playerToReplace = null;
        let replacementPlayer = null;
        let isSwitchModeActive = false; // We use this to control switching mode

        // Function to highlight selected position
        function highlightPosition(positionDiv, color = 'green') {
            selectedPositionReplace = null;
            document.querySelectorAll(".pitch-position").forEach((div) => {
                div.style.border = ""; // Reset all
            });
            if (positionDiv) {
                positionDiv.style.border = `2px dashed ${color}`;
                selectedPositionElement = positionDiv;
            }
        }

        // Function called when a player on pitch is clicked
        function onPlayerCardClick(playerCardElement) {
            playerIdRemoved = playerCardElement.getAttribute("data-playerid");
            teamPlayerIdRemoved = playerCardElement.getAttribute("data-team");
            RemovedPlayerPrice = playerCardElement.getAttribute("data-price");

            showPlayerModal(
                playerCardElement.getAttribute("data-name"), 
                playerCardElement.getAttribute("data-playerid"),
                playerCardElement.getAttribute("data-image"),
                playerCardElement.getAttribute("data-position"),
                playerCardElement.getAttribute("data-price") || "£0.0m",
                playerCardElement.getAttribute("data-form") || "N/A",
                playerCardElement.getAttribute("data-tsb") || "0%",
                playerCardElement.getAttribute("data-team") || "Unknown Team",
                playerCardElement.getAttribute("data-teamlogo"),
                {
                    team1: playerCardElement.getAttribute("data-fixture-team1") || "Team A",
                    team1Logo: playerCardElement.getAttribute("data-fixture-team1logo"),
                    team2: playerCardElement.getAttribute("data-fixture-team2") || "Team B",
                    team2Logo: playerCardElement.getAttribute("data-fixture-team2logo"),
                    time: playerCardElement.getAttribute("data-fixture-time") || "TBD"
                }
            );
        }

        // Setup event listeners on pitch players
        document.querySelectorAll(".pitch-position").forEach((positionDiv) => {
            positionDiv.addEventListener("click", function () {
                if (!isSwitchModeActive) {
                    const playerCardElement = this.querySelector(".player-card-save");
                    console.log(playerCardElement);
                    if (playerCardElement) {
                        console.log('Inside');
                        console.log(playerCardElement);
                        // onPlayerCardClick(playerCardElement); // Open modal
                        selectedPositionElement = this; // Remember clicked element
                    }
                }
            });
        });

        // "Switch" Button inside Modal
        document.getElementById("switchOutButton").addEventListener("click", function () {
            if (ReplaceLocationChanger === 1) {
                document.getElementById("playerModal").style.display = "none"; // Close modal
                
                if (!playerToReplace) {
                    // First click (store the player to replace)
                    if (selectedPositionElement) {
                        playerToReplace = {
                            element: selectedPositionElement,
                            playerId: playerIdRemoved,
                            team: teamPlayerIdRemoved,
                            price: RemovedPlayerPrice
                        };
                        highlightPosition(selectedPositionElement, 'red');
                        showToast("Now select a replacement player", "info");
                        isSwitchModeActive = true; // Start switch mode
                    } else {
                        showToast("No player selected.", "warning");
                    }
                } else if (playerToReplace && !replacementPlayer) {
                    // Second click (store the replacement player)
                    if (selectedPositionElement) {
                        replacementPlayer = {
                            element: selectedPositionElement,
                            playerId: playerIdRemoved,
                            team: teamPlayerIdRemoved,
                            price: RemovedPlayerPrice
                        };
                        // Perform swap
                        swapPlayers(playerToReplace, replacementPlayer);
                        
                        // Reset all
                        playerToReplace = null;
                        replacementPlayer = null;
                        isSwitchModeActive = false;
                        highlightPosition(null);
                        showToast("Players swapped successfully!", "success");
                    } else {
                        showToast("No replacement player selected.", "warning");
                    }
                }
            }
        });

        // Function to swap players on the pitch
        function swapPlayers(playerA, playerB) {
            const tempHTML = playerA.element.innerHTML;
            playerA.element.innerHTML = playerB.element.innerHTML;
            playerB.element.innerHTML = tempHTML;

            // ⚡ Re-attach the click event to new player cards inside playerA and playerB
            const newPlayerCardA = playerA.element.querySelector(".player-card-save");
            const newPlayerCardB = playerB.element.querySelector(".player-card-save");


            if (newPlayerCardA) {
                newPlayerCardA.addEventListener("click", function () {
                    playerIdRemoved = this.getAttribute("data-playerid");
                    teamPlayerIdRemoved = this.getAttribute("data-team");
                    RemovedPlayerPrice = this.getAttribute("data-price");
                    showPlayerModal(
                        this.getAttribute("data-name"), 
                        this.getAttribute("data-playerid"),
                        this.getAttribute("data-image"),
                        this.getAttribute("data-position"),
                        this.getAttribute("data-price") || "£0.0m",
                        this.getAttribute("data-form") || "N/A",
                        this.getAttribute("data-tsb") || "0%",
                        this.getAttribute("data-team") || "Unknown Team",
                        this.getAttribute("data-teamlogo"),
                        {
                            team1: this.getAttribute("data-fixture-team1") || "Team A",
                            team1Logo: this.getAttribute("data-fixture-team1logo"),
                            team2: this.getAttribute("data-fixture-team2") || "Team B",
                            team2Logo: this.getAttribute("data-fixture-team2logo"),
                            time: this.getAttribute("data-fixture-time") || "TBD"
                        }
                    );
                    selectedPositionElement = playerA.element; // Update selected position
                });
            }

            if (newPlayerCardB) {
                newPlayerCardB.addEventListener("click", function () {
                    playerIdRemoved = this.getAttribute("data-playerid");
                    teamPlayerIdRemoved = this.getAttribute("data-team");
                    RemovedPlayerPrice = this.getAttribute("data-price");
                    showPlayerModal(
                        this.getAttribute("data-name"), 
                        this.getAttribute("data-playerid"),
                        this.getAttribute("data-image"),
                        this.getAttribute("data-position"),
                        this.getAttribute("data-price") || "£0.0m",
                        this.getAttribute("data-form") || "N/A",
                        this.getAttribute("data-tsb") || "0%",
                        this.getAttribute("data-team") || "Unknown Team",
                        this.getAttribute("data-teamlogo"),
                        {
                            team1: this.getAttribute("data-fixture-team1") || "Team A",
                            team1Logo: this.getAttribute("data-fixture-team1logo"),
                            team2: this.getAttribute("data-fixture-team2") || "Team B",
                            team2Logo: this.getAttribute("data-fixture-team2logo"),
                            time: this.getAttribute("data-fixture-time") || "TBD"
                        }
                    );
                    selectedPositionElement = playerB.element; // Update selected position
                });
            }
        }

    </script>

    <!-- Pitch Players Hide -->
    <style>
        /* Initially hide the button */
        #hideDivLink {
            display: none;
        } 

        /* By default, show the button */
        #showDivLink {
            display: block;
        }

        /* On large screens (768px or more), hide the button */
        @media screen and (min-width: 768px) {
            #showDivLink {
                display: none !important;
            }
        }

        /* Show the button only on small screens (max-width: 768px) */
        @media screen and (max-width: 768px) {
            #hideDivLink {
                display: block; /* Make it visible on small screens */
            }
            #targetDiv1 {
                display: none; /* Force the divs to show on large screens */
            }
        }

        /* Show the divs on larger screens (min-width: 768px), and ensure they are always visible */
        @media screen and (min-width: 768px) {
            #targetDiv, #targetDiv1 {
                display: block !important; /* Force the divs to show on large screens */
            }
        }


    </style>

    {% endblock %}






    <!-- 
    
    find contests/templates/contests/ -type f -name "*.html" -exec iconv -f ISO-8859-1 -t UTF-8 {} -o {}.converted \;
    find contests/templates/contests/ -type f -name "*.converted" -exec sh -c 'mv "$1" "${1%.converted}"' _ {} \; 


    find contests/templates/contests/ -type f -exec bash -c 'file -i "$1" | grep -q "charset=us-ascii\|charset=iso-8859-1" && iconv -f ISO-8859-1 -t UTF-8//IGNORE "$1" -o "$1".utf8' _ {} \;
    find contests/templates/contests/ -type f -name "*.utf8" -exec sh -c 'mv "$1" "${1%.utf8}"' _ {} \;
    file -i contests/templates/contests/*.html
    
    -->