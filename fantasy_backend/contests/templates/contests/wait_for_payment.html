{% extends 'contests/base.html' %}

{% block title %}Waiting for Payment{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="p-4 rounded shadow-sm" style="background-color: #fff3cd; border: 1px solid #ffeeba;">
        <div class="d-flex align-items-center mb-4">
            <i class="fas fa-clock text-warning" style="font-size: 3rem; margin-right: 10px;"></i>
            <h2 class="fw-bold text-dark mb-0">Awaiting Payment Confirmation</h2>
        </div>

        <p class="text-muted">
            A payment prompt has been sent to your phone. Please complete the payment on your device.<br>
            <strong>Do not refresh this page.</strong>
        </p>

        <div id="payment-status" class="text-center mt-4">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Waiting for payment confirmation...</p>
        </div>
        <div id="retry-section" class="text-center mt-4" style="display:none;">
            <a href="{% url 'entry-payment' %}" class="btn btn-warning px-4">Retry Payment</a>
        </div>
    </div>
</div>


<script>
    // Poll the backend every 3 seconds for payment status
    let waitTimeout = setTimeout(function() {
        document.getElementById('payment-status').innerHTML = '<div class="alert alert-warning">No response from M-Pesa. Please try again or check your phone for a pending prompt.</div>';
        document.getElementById('retry-section').style.display = 'block';
    }, 60000); // 2 minutes

    function checkPaymentStatus() {
        fetch("{% url 'check-payment-status' %}")
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    clearTimeout(waitTimeout);
                    window.location.href = data.redirect_url;
                } else if (data.status === 'not_found') {
                    clearTimeout(waitTimeout);
                    document.getElementById('payment-status').innerHTML = '<div class="alert alert-danger">Payment session not found. Please try again.</div>';
                    document.getElementById('retry-section').style.display = 'block';
                } else if (data.status === 'failed') {
                    clearTimeout(waitTimeout);
                    document.getElementById('payment-status').innerHTML = '<div class="alert alert-danger">Payment failed. Please try again.</div>';
                    document.getElementById('retry-section').style.display = 'block';
                } else {
                    setTimeout(checkPaymentStatus, 3000);
                }
            })
            .catch(() => {
                setTimeout(checkPaymentStatus, 3000);
            });
    }
    checkPaymentStatus();
</script>
{% endblock %}